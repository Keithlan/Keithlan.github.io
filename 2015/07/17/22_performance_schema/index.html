
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Mysql5.6 Performance_schema 深入浅出 | Focus on MySQL,Focus on Focus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" itemprop="description" content="主要了解mysql非常强劲的特性，也是我比较喜欢的，performance_schema. Performance_schema 的专家是 Mark Leith对这方面的研究非常多，可以多看看他的blog。">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Focus">Focus on MySQL,Focus on Focus</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/17/22_performance_schema/" title="Mysql5.6 Performance_schema 深入浅出" itemprop="url">Mysql5.6 Performance_schema 深入浅出</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2015-07-17T03:32:24.000Z" itemprop="datePublished">Jul 17 2015</time>
    Updated:<time datetime="2016-08-19T01:52:28.000Z" itemprop="dateModified">Aug 19 2016</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目录结构"><span class="toc-number">1.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#架构图"><span class="toc-number">2.</span> <span class="toc-text">架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql_5-5_Performance_schema"><span class="toc-number">3.</span> <span class="toc-text">Mysql 5.5 Performance schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql_5-6_Performance_schema"><span class="toc-number">4.</span> <span class="toc-text">Mysql 5.6 Performance schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql_5-7_Performance_schema"><span class="toc-number">5.</span> <span class="toc-text">Mysql 5.7 Performance schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#consumer_层次图"><span class="toc-number">6.</span> <span class="toc-text">consumer 层次图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Statement_诊断"><span class="toc-number">7.</span> <span class="toc-text">Statement 诊断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-1_performance_Schema_快速入门"><span class="toc-number">8.</span> <span class="toc-text">22.1 performance Schema 快速入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-2_Performance_Schema_配置"><span class="toc-number">9.</span> <span class="toc-text">22.2 Performance Schema 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-1_mysql编译的时候_修改Performance_Schema配置"><span class="toc-number">9.1.</span> <span class="toc-text">22.2.1 mysql编译的时候 修改Performance Schema配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-2_mysql启动的时候_修改Performance_Schema配置"><span class="toc-number">9.2.</span> <span class="toc-text">22.2.2 mysql启动的时候 修改Performance Schema配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-3_mysql运行过程中_修改Performance_Schema配置"><span class="toc-number">9.3.</span> <span class="toc-text">22.2.3 mysql运行过程中 修改Performance Schema配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-3-1_performance_schema事件计时"><span class="toc-number">9.3.1.</span> <span class="toc-text">22.2.3.1 performance_schema事件计时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-3-2_performance_schema_过滤事件"><span class="toc-number">9.3.2.</span> <span class="toc-text">22.2.3.2 performance_schema 过滤事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-3-3_Pre-Filtering_事件"><span class="toc-number">9.3.3.</span> <span class="toc-text">22.2.3.3 Pre-Filtering 事件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-1_Pre-Filtering_by_Instrument"><span class="toc-number">9.3.3.1.</span> <span class="toc-text">22.2.3.3.1 Pre-Filtering by Instrument</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-2_Pre-Filtering_by_Object"><span class="toc-number">9.3.3.2.</span> <span class="toc-text">22.2.3.3.2 Pre-Filtering by Object</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-3_Pre-Filtering_by_Thread"><span class="toc-number">9.3.3.3.</span> <span class="toc-text">22.2.3.3.3 Pre-Filtering by Thread</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-4_Pre-Filtering_by_Consumer"><span class="toc-number">9.3.3.4.</span> <span class="toc-text">22.2.3.3.4 Pre-Filtering by Consumer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-5_Example_Consumer_Configurations"><span class="toc-number">9.3.3.5.</span> <span class="toc-text">22.2.3.3.5 Example Consumer Configurations</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-3_Performance_Schema_Queries"><span class="toc-number">10.</span> <span class="toc-text">22.3 Performance Schema Queries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-4_Performance_Schema_Instrument命名规则"><span class="toc-number">11.</span> <span class="toc-text">22.4 Performance Schema Instrument命名规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-5_performance_schema_状态监控"><span class="toc-number">12.</span> <span class="toc-text">22.5 performance schema 状态监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-8_Performance_Schema_General_Table_Characteristics"><span class="toc-number">13.</span> <span class="toc-text">22.8 Performance Schema General Table Characteristics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后注意事项"><span class="toc-number">14.</span> <span class="toc-text">最后注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">15.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1)_源码：https://github-com/MarkLeith/mysql-sys/"><span class="toc-number">15.1.</span> <span class="toc-text">1) 源码：https://github.com/MarkLeith/mysql-sys/</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）这里面的代码参考Mark_leith，有部分做过修改，也有部分对线上影响非常大。"><span class="toc-number">15.2.</span> <span class="toc-text">2）这里面的代码参考Mark leith，有部分做过修改，也有部分对线上影响非常大。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3）对所有view都做过详细解释与实战测试，有部分坑里面说明"><span class="toc-number">15.3.</span> <span class="toc-text">3）对所有view都做过详细解释与实战测试，有部分坑里面说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">16.</span> <span class="toc-text">参考资料</span></a></li></ol>
		</div>
		
		<h2 id="目录结构">目录结构</h2>
<ul>
<li><strong>22.1 performance Schema 快速入门</strong></li>
<li><strong>22.2 Performance Schema 配置</strong><ul>
<li><strong>22.2.1 mysql编译的时候 修改Performance Schema配置</strong></li>
<li><strong>22.2.2 mysql启动的时候 修改Performance Schema配置</strong></li>
<li><strong>22.2.3 mysql运行过程中 修改Performance Schema配置</strong></li>
</ul>
</li>
<li><strong>22.3 Performance Schema 查询</strong></li>
<li><strong>22.4 Performance Schema Instrument Naming Conventions</strong></li>
<li><strong>22.5 Performance Schema Status 监控</strong></li>
<li><strong>22.6 Performance Schema 原子性，分子性 事件</strong></li>
<li><strong>22.7 Performance Schema Statement 诊断</strong></li>
<li><strong>22.8 Performance Schema 基本表特征</strong></li>
<li><strong>22.9 Performance Schema 表的描述</strong><ul>
<li><strong>22.9.1 Performance Schema 表的索引</strong></li>
<li><strong>22.9.2 Performance Schema Setup 类型的表</strong></li>
<li><strong>22.9.3 Performance Schema Instance 类型的表</strong></li>
<li><strong>22.9.4 Performance Schema Wait Event 类型的表</strong></li>
<li><strong>22.9.5 Performance Schema Stage Event 类型的表</strong></li>
<li><strong>22.9.6 Performance Schema Statement Event 类型的表</strong></li>
<li><strong>22.9.7 Performance Schema Connection 类型的表</strong></li>
<li><strong>22.9.8 Performance Schema Connection Attribute 类型的表</strong></li>
<li><strong>22.9.9 Performance Schema Summary 类型的表</strong></li>
<li><strong>22.9.10 Performance Schema 其他类型的表</strong></li>
</ul>
</li>
<li><strong>22.10 Performance Schema 变量与选项</strong></li>
<li><strong>22.11 Performance Schema 命令选项</strong></li>
<li><strong>22.12 Performance Schema 系统变量</strong></li>
<li><strong>22.13 Performance Schema status变量</strong></li>
<li><strong>22.14 Performance Schema 与插件</strong></li>
<li><p><strong>22.15 使用Performance Schema 来诊断问题</strong></p>
<ul>
<li><strong>22.15.1 使用Performance Schema来替代profiling</strong></li>
</ul>
</li>
<li><p><strong>心得： performance_schema的使用</strong></p>
</li>
</ul>
<h2 id="架构图">架构图</h2>
<hr>
<h2 id="Mysql_5-5_Performance_schema">Mysql 5.5 Performance schema</h2>
<p><img src="/image/mysql_ref/5.5.png" alt="55" title="55"></p>
<h2 id="Mysql_5-6_Performance_schema">Mysql 5.6 Performance schema</h2>
<p><img src="/image/mysql_ref/5.6.png" alt="56" title="56"></p>
<h2 id="Mysql_5-7_Performance_schema">Mysql 5.7 Performance schema</h2>
<p><img src="/image/mysql_ref/5.7.png" alt="57" title="57"></p>
<h2 id="consumer_层次图">consumer 层次图</h2>
<p><img src="/image/mysql_ref/consumer.png" alt="consumer" title="consumer"></p>
<h2 id="Statement_诊断">Statement 诊断</h2>
<p><img src="/image/mysql_ref/statement.png" alt="statement" title="statement"></p>
<h2 id="22-1_performance_Schema_快速入门">22.1 performance Schema 快速入门</h2>
<p>这一节简单的讲解如何使用performance schema，并附上例子。如： Section 22.15, “Using the Performance Schema to Diagnose Problems”</p>
<p>如果要让mysql可用，必须在mysql编译的时候built进来。通过检查服务器的帮助信息，你也可以确认一下perf 是否可用。如果可用，会有一些提示如：</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqld --verbose --help</div><div class="line">...</div><div class="line">  --performance_schema</div><div class="line">                      Enable the performance schema.</div><div class="line">  --performance_schema_events_waits_history_long_size=#</div><div class="line">                     Number of rows in events_waits_history_long.</div><div class="line">...</div></pre></td></tr></table></figure>



<p>如果以上变量没有出现在你的output上，那么说明你的mysql不支持performance schema。<br>请关注 Section 22.2, “Performance Schema Configuration”.</p>
<p>如果你performance schema被支持，那么在mysql5.6.6开始就已经默认打开的。<br>如果要显示打开关闭PS，那么就在mysql启动的时候加上performance_schema变量，<br>并且给予适当的值。比如：在你的my.cnf文件中</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">performance_schema=ON</div></pre></td></tr></table></figure>

<p>一旦这样配置后，当mysql启动时，就会自动初始化performance schema。为了验证初始化是否成功，<br>可以使用这样的语句：</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW VARIABLES LIKE 'performance_schema';</div><div class="line">+--------------------+-------+</div><div class="line">| Variable_name      | Value |</div><div class="line">+--------------------+-------+</div><div class="line">| performance_schema | ON    |</div><div class="line">+--------------------+-------+</div></pre></td></tr></table></figure>

<p>ON表示成功，OFF表示有错误，请查看相关error log 定位错误。</p>
<p>performance schema 是以存储引擎的方式实现的，你可以通过INFORMATION_SCHEMA.ENGINES 或者<br>show engines来确认：</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM INFORMATION_SCHEMA.ENGINES</div><div class="line">    -&gt; WHERE ENGINE='PERFORMANCE_SCHEMA'\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">      ENGINE: PERFORMANCE_SCHEMA</div><div class="line">     SUPPORT: YES</div><div class="line">     COMMENT: Performance Schema</div><div class="line">TRANSACTIONS: NO</div><div class="line">          XA: NO</div><div class="line">  SAVEPOINTS: NO</div><div class="line"></div><div class="line">mysql&gt; SHOW ENGINES\G</div><div class="line">...</div><div class="line">      Engine: PERFORMANCE_SCHEMA</div><div class="line">     Support: YES</div><div class="line">     Comment: Performance Schema</div><div class="line">Transactions: NO</div><div class="line">          XA: NO</div><div class="line">  Savepoints: NO</div><div class="line">...</div></pre></td></tr></table></figure>

<p>你可以像使用正常database一样使用performance schema。<br>比如：use performance_schema, 以及show语法。</p>
<p>performance_schema数据库名必须是小写。可以使用show create table 查看表：</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW CREATE TABLE setup_timers\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">       Table: setup_timers</div><div class="line">Create Table: CREATE TABLE `setup_timers` (</div><div class="line">  `NAME` varchar(64) NOT NULL,</div><div class="line">  `TIMER_NAME` enum('CYCLE','NANOSECOND','MICROSECOND','MILLISECOND','TICK')</div><div class="line">   NOT NULL</div><div class="line">) ENGINE=PERFORMANCE_SCHEMA DEFAULT CHARSET=utf8</div></pre></td></tr></table></figure>

<p>也可以查询 INFORMATION_SCHEMA.COLUMNS来查看列。</p>
<p>performance_schema里面的表可以根据名字分类为：</p>
<ul>
<li>Current events</li>
<li>event histories </li>
<li>summaries</li>
<li>object instances</li>
<li>setup (configuration)</li>
</ul>
<p>下面有些例子来简单的使用这些表，详细的使用请看：Section 22.9, “Performance Schema Table Descriptions”.</p>
<p>一开始，不是所有的instrument 和 consumer 都会被enable ， 所以一开始他们不会收集所有的事件。<br>为了让他们都enable 或者 enable event timing。 执行以下两条语句</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mysql&gt; UPDATE setup_instruments SET ENABLED = 'YES', TIMED = 'YES';</div><div class="line">Query OK, 338 rows affected (0.12 sec)</div><div class="line">mysql&gt; UPDATE setup_consumers SET ENABLED = 'YES';</div><div class="line">Query OK, 8 rows affected (0.00 sec)</div></pre></td></tr></table></figure>

<p>如果想查看某个时刻的等待事件，可以查询 events_waits_current表。它记录了每个thread最近的监控信息。</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM events_waits_current\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">            THREAD_ID: 0</div><div class="line">             EVENT_ID: 5523</div><div class="line">           EVENT_NAME: wait/synch/mutex/mysys/THR_LOCK::mutex</div><div class="line">               SOURCE: thr_lock.c:525</div><div class="line">          TIMER_START: 201660494489586</div><div class="line">            TIMER_END: 201660494576112</div><div class="line">           TIMER_WAIT: 86526</div><div class="line">                SPINS: NULL</div><div class="line">        OBJECT_SCHEMA: NULL</div><div class="line">          OBJECT_NAME: NULL</div><div class="line">          OBJECT_TYPE: NULL</div><div class="line">OBJECT_INSTANCE_BEGIN: 142270668</div><div class="line">     NESTING_EVENT_ID: NULL</div><div class="line">            OPERATION: lock</div><div class="line">      NUMBER_OF_BYTES: NULL</div><div class="line">                FLAGS: 0</div><div class="line">...</div></pre></td></tr></table></figure>

<p>这个事件说明 thread 0 在等待86526皮秒 来获得一个锁THR_LOCK::mutex，而这个锁是mysys子系统中。<br>以下是列的一些描述</p>
<ul>
<li>id： thread id</li>
<li>event name：别监控的instrument名字</li>
<li>timer 类型的列： 时间，以皮秒为基准单位</li>
</ul>
<p>history 表包含了一些列相同事件的历史记录，就如同current-events 一样，不同的是，<br>有更多的记录来说明服务器最近做了什么，而不是当前做了什么。events_waits_history &amp; events_waits_history_long 记录了每个thread最近10条和10000条event。</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT EVENT_ID, EVENT_NAME, TIMER_WAIT</div><div class="line">    -&gt; FROM events_waits_history WHERE THREAD_ID = 13</div><div class="line">    -&gt; ORDER BY EVENT_ID;</div><div class="line">+----------+-----------------------------------------+------------+</div><div class="line">| EVENT_ID | EVENT_NAME                              | TIMER_WAIT |</div><div class="line">+----------+-----------------------------------------+------------+</div><div class="line">|       86 | wait/synch/mutex/mysys/THR_LOCK::mutex  |     686322 |</div><div class="line">|       87 | wait/synch/mutex/mysys/THR_LOCK_malloc  |     320535 |</div><div class="line">|       88 | wait/synch/mutex/mysys/THR_LOCK_malloc  |     339390 |</div><div class="line">|       89 | wait/synch/mutex/mysys/THR_LOCK_malloc  |     377100 |</div><div class="line">|       90 | wait/synch/mutex/sql/LOCK_plugin        |     614673 |</div><div class="line">|       91 | wait/synch/mutex/sql/LOCK_open          |     659925 |</div><div class="line">|       92 | wait/synch/mutex/sql/THD::LOCK_thd_data |     494001 |</div><div class="line">|       93 | wait/synch/mutex/mysys/THR_LOCK_malloc  |     222489 |</div><div class="line">|       94 | wait/synch/mutex/mysys/THR_LOCK_malloc  |     214947 |</div><div class="line">|       95 | wait/synch/mutex/mysys/LOCK_alarm       |     312993 |</div><div class="line">+----------+-----------------------------------------+------------+</div></pre></td></tr></table></figure>

<p>如果这个表满了，那么新的event会被加进来，踢掉最老的那个。</p>
<p>summary 表提供了整个时间段的一些统计信息。他们统计事件的处理方式和之前都不一样。<br>如果想知道某个instrument 被执行的最频繁，或者发生的频率非常高，可以通过排序 events_waits_summary_global_by_event_name表，根据 COUNT_STAR 或者 SUM_TIMER_WAIT列。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">mysql&gt; SELECT EVENT_NAME, COUNT_STAR</div><div class="line">    -&gt; <span class="keyword">FROM</span> events_waits_summary_global_by_event_name</div><div class="line">    -&gt; ORDER BY COUNT_STAR DESC LIMIT <span class="number">10</span>;</div><div class="line">+---------------------------------------------------+------------+</div><div class="line">| EVENT_NAME                                        | COUNT_STAR |</div><div class="line">+---------------------------------------------------+------------+</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/mysys/</span>THR_LOCK_malloc            |       <span class="number">6419</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/sql/</span>FRM                              |        <span class="number">452</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/sql/</span>LOCK_plugin                  |        <span class="number">337</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/mysys/</span>THR_LOCK_open              |        <span class="number">187</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/mysys/</span>LOCK_alarm                 |        <span class="number">147</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/sql/</span>THD::LOCK_thd_data           |        <span class="number">115</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/myisam/</span>kfile                         |        <span class="number">102</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/sql/</span>LOCK_global_system_variables |         <span class="number">89</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/mysys/</span>THR_LOCK::mutex            |         <span class="number">89</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/sql/</span>LOCK_open                    |         <span class="number">88</span> |</div><div class="line">+---------------------------------------------------+------------+</div><div class="line"></div><div class="line">mysql&gt; SELECT EVENT_NAME, SUM_TIMER_WAIT</div><div class="line">    -&gt; <span class="keyword">FROM</span> events_waits_summary_global_by_event_name</div><div class="line">    -&gt; ORDER BY SUM_TIMER_WAIT DESC LIMIT <span class="number">10</span>;</div><div class="line">+----------------------------------------+----------------+</div><div class="line">| EVENT_NAME                             | SUM_TIMER_WAIT |</div><div class="line">+----------------------------------------+----------------+</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/sql/</span>MYSQL_LOG             |     <span class="number">1599816582</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/mysys/</span>THR_LOCK_malloc |     <span class="number">1530083250</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/sql/</span>binlog_index          |     <span class="number">1385291934</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/sql/</span>FRM                   |     <span class="number">1292823243</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/myisam/</span>kfile              |      <span class="number">411193611</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/myisam/</span>dfile              |      <span class="number">322401645</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/mysys/</span>LOCK_alarm      |      <span class="number">145126935</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/sql/</span>casetest              |      <span class="number">104324715</span> |</div><div class="line">| wait<span class="regexp">/synch/m</span>utex<span class="regexp">/sql/</span>LOCK_plugin       |       <span class="number">86027823</span> |</div><div class="line">| wait<span class="regexp">/io/</span><span class="keyword">file</span><span class="regexp">/sql/</span>pid                   |       <span class="number">72591750</span> |</div><div class="line">+----------------------------------------+----------------+</div></pre></td></tr></table></figure>

<p>以上说明THR_LOCK_malloc 非常hot。</p>
<p>instance 表记录了什么类型的object被instrumented。一个被instrumented的object，当被server使用时就会产生一个event。这些表提供了event名以及简单的阐述。<br>比如：file_instances 就列出了file IO相关的instance of instrument。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">xxx:performance<span class="emphasis">_schema&gt; show tables like '%_</span>instances'</div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+--------------------------------------------+</div><div class="line"><span class="header">| Tables_in_performance_schema (%_instances) |</span></div><div class="line">+--------------------------------------------+</div><div class="line">| cond<span class="emphasis">_instances                             |</span></div><div class="line">| file_instances                             |</div><div class="line">| mutex<span class="emphasis">_instances                            |</span></div><div class="line">| rwlock_instances                           |</div><div class="line"><span class="header">| socket_instances                           |</span></div><div class="line">+--------------------------------------------+</div><div class="line">5 rows in set (0.00 sec)</div></pre></td></tr></table></figure>



<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM file_instances\G</div><div class="line">*************************** 1. row ***************************</div><div class="line"> FILE_NAME: /opt/mysql-log/60500/binlog.000007</div><div class="line">EVENT_NAME: wait/io/file/sql/binlog</div><div class="line">OPEN_COUNT: 0</div><div class="line">*************************** 2. row ***************************</div><div class="line"> FILE_NAME: /opt/mysql/60500/data/mysql/tables_priv.MYI</div><div class="line">EVENT_NAME: wait/io/file/myisam/kfile</div><div class="line">OPEN_COUNT: 1</div><div class="line">*************************** 3. row ***************************</div><div class="line"> FILE_NAME: /opt/mysql/60500/data/mysql/columns_priv.MYI</div><div class="line">EVENT_NAME: wait/io/file/myisam/kfile</div><div class="line">OPEN_COUNT: 1</div><div class="line">...</div></pre></td></tr></table></figure>

<p>setup表用来配置和显示监控信息的。 例如：什么样的timer 被使用，<br>请查询setup_timers</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM setup_timers;</div><div class="line">+-----------+-------------+</div><div class="line">| NAME      | TIMER_NAME  |</div><div class="line">+-----------+-------------+</div><div class="line">| idle      | MICROSECOND |</div><div class="line">| wait      | CYCLE       |</div><div class="line">| stage     | NANOSECOND  |</div><div class="line">| statement | NANOSECOND  |</div><div class="line">+-----------+-------------+</div></pre></td></tr></table></figure>

<p>setup_instruments 列出了哪些event会被收集与监控：</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM setup_instruments;</div><div class="line">+------------------------------------------------------------+---------+-------+</div><div class="line">| NAME                                                       | ENABLED | TIMED |</div><div class="line">+------------------------------------------------------------+---------+-------+</div><div class="line">...</div><div class="line">| wait/synch/mutex/sql/LOCK_global_read_lock                 | YES     | YES   |</div><div class="line">| wait/synch/mutex/sql/LOCK_global_system_variables          | YES     | YES   |</div><div class="line">| wait/synch/mutex/sql/LOCK_lock_db                          | YES     | YES   |</div><div class="line">| wait/synch/mutex/sql/LOCK_manager                          | YES     | YES   |</div><div class="line">...</div><div class="line">| wait/synch/rwlock/sql/LOCK_grant                           | YES     | YES   |</div><div class="line">| wait/synch/rwlock/sql/LOGGER::LOCK_logger                  | YES     | YES   |</div><div class="line">| wait/synch/rwlock/sql/LOCK_sys_init_connect                | YES     | YES   |</div><div class="line">| wait/synch/rwlock/sql/LOCK_sys_init_slave                  | YES     | YES   |</div><div class="line">...</div><div class="line">| wait/io/file/sql/binlog                                    | YES     | YES   |</div><div class="line">| wait/io/file/sql/binlog_index                              | YES     | YES   |</div><div class="line">| wait/io/file/sql/casetest                                  | YES     | YES   |</div><div class="line">| wait/io/file/sql/dbopt                                     | YES     | YES   |</div><div class="line">...</div></pre></td></tr></table></figure>

<p>相应了解如何翻译这些instrument 的名字，请看：Section 22.4, “Performance Schema Instrument Naming Conventions”.</p>
<p>为了控制哪些event是不是instrument，可以给enabled设置yes or no。</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; UPDATE setup_instruments SET ENABLED = 'NO'</div><div class="line">    -&gt; WHERE NAME = 'wait/synch/mutex/sql/LOCK_mysql_create_db';</div></pre></td></tr></table></figure>

<p>performance schema 使用收集的events 来更新performance_schema 数据库的那些表，这些表扮演着事件信息消费者的角色。setup_consumers 列出了可用的消费者 以及哪些是enabled。</p>
<figure class="highlight SQL"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT * FROM setup_consumers;</div><div class="line">+--------------------------------+---------+</div><div class="line">| NAME                           | ENABLED |</div><div class="line">+--------------------------------+---------+</div><div class="line">| events_stages_current          | NO      |</div><div class="line">| events_stages_history          | NO      |</div><div class="line">| events_stages_history_long     | NO      |</div><div class="line">| events_statements_current      | YES     |</div><div class="line">| events_statements_history      | NO      |</div><div class="line">| events_statements_history_long | NO      |</div><div class="line">| events_waits_current           | NO      |</div><div class="line">| events_waits_history           | NO      |</div><div class="line">| events_waits_history_long      | NO      |</div><div class="line">| global_instrumentation         | YES     |</div><div class="line">| thread_instrumentation         | YES     |</div><div class="line">| statements_digest              | YES     |</div><div class="line">+--------------------------------+---------+</div></pre></td></tr></table></figure>

<h2 id="22-2_Performance_Schema_配置">22.2 Performance Schema 配置</h2>
<h3 id="22-2-1_mysql编译的时候_修改Performance_Schema配置">22.2.1 mysql编译的时候 修改Performance Schema配置</h3>
<p>目前，一般的binary版本都会默认支持PS，不过最后还是想官方的provider 确认一下。<br>如果使用的是源码包，用cmake WITH_PERFSCHEMA_STORAGE_ENGINE 使其ok</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">shell&gt;</span> cmake . -<span class="constant">DWITH_PERFSCHEMA_STORAGE_ENGINE</span>=<span class="number">1</span></span></div></pre></td></tr></table></figure>

<p>如何check是否支持performance schema？<br>第一：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">shell&gt; mysqld --verbose --help</div><div class="line"><span class="keyword">...</span></div><div class="line">  --performance_schema</div><div class="line">                      Enable the performance schema.</div><div class="line">  --performance_schema_events_waits_history_long_size=<span class="comment">#</span></div><div class="line">                      Number of rows <span class="keyword">in</span> events_waits_history_long.</div><div class="line"><span class="keyword">...</span></div></pre></td></tr></table></figure>

<p>也可以</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW ENGINES\G</div><div class="line"><span class="keyword">...</span></div><div class="line">      Engine: PERFORMANCE_SCHEMA</div><div class="line">     Support: YES</div><div class="line">     Comment: Performance Schema</div><div class="line">Transactions: NO</div><div class="line">          XA: NO</div><div class="line">  Savepoints: NO</div><div class="line"><span class="keyword">...</span></div></pre></td></tr></table></figure>

<p>注意：show engines 中即便包含了PERFORMANCE_SCHEMA，只能说明已经支持，不代表已经开启。<br>如果要开启，必须在start up阶段设置，请看下一章节。</p>
<h3 id="22-2-2_mysql启动的时候_修改Performance_Schema配置">22.2.2 mysql启动的时候 修改Performance Schema配置</h3>
<p>假设编译的时候已经支持ps，那么mysql5.6.6 版本以及以上版本都会默认enable 。<br>开启，只需要在my.cnf中</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="title">[mysqld]</span></div><div class="line"><span class="setting">performance_schema=<span class="value"><span class="keyword">ON</span></span></span></div></pre></td></tr></table></figure>

<p>如果server没有足够多的内存用于初始化performance schema，那么它会自己disable 掉，然后没有instrument相关信息。</p>
<p>mysql5.6.4版本开始，允许instrument 和 consumer在server startup阶段配置。之前的版本都<br>只能在runtime阶段用update配置。</p>
<p>在startup阶段控制instrument，可以用这种形式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-performance-schema-instrument=<span class="string">'instrument_name=value'</span></span></div></pre></td></tr></table></figure>

<p>这里面instrument_name 指的是类似wait/synch/mutex/sql/LOCK_open这种instrument，<br>value 就是下面其中一种：</p>
<ul>
<li>OFF，False， or 0 关闭这个instrument</li>
<li>ON，TRUE，or 1 开启这个instrument</li>
<li>counted：开启并且统计这个instrument</li>
</ul>
<p>—performance-schema-instrument 只能指定一个instrument名字。多个instances可以在多instrument中配置。另外：模式也是被允许的。如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-performance-schema-instrument=<span class="string">'wait/synch/cond/%=COUNTED'</span></span></div></pre></td></tr></table></figure>

<p>关闭所有instrument，使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-performance-schema-instrument=<span class="string">'%=OFF'</span></span></div></pre></td></tr></table></figure>

<p>在startup阶段控制consumer</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-performance-schema-consumer-<span class="variable">$consumer_name</span>=<span class="variable">$value</span></span></div></pre></td></tr></table></figure>

<p>这里面$consumer_name 指的是consumer 如：events_waits_history，<br>$value 为：</p>
<ul>
<li>OFF，FALSE，or 0： 不收集这个consumer相关的事件</li>
<li>ON，TRUE，or 1 ： 收集这个consumer相关的事件</li>
</ul>
<p>例如：开启events_waits_history consumer，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="setting">--performance-schema-consumer-events-waits-history=<span class="value"><span class="keyword">ON</span></span></span></div></pre></td></tr></table></figure>

<p>合法的consumer的名字可以在setup_consumers表中找到。模式匹配是不允许的。<br>consumer的名字在setup_consumers中以下划线表示，但是在starup 阶段的my.cnf配置文件中，<br>下划线和横线都是被允许的。</p>
<p>performance schema的默认系统变量：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mysql&gt; <span class="class">SHOW</span> <span class="class">VARIABLES</span> <span class="class">LIKE</span> <span class="string">'perf%'</span>;</div><div class="line">+--------------------------------------------------------+---------+</div><div class="line">| <span class="class">Variable_name</span>                                          | <span class="class">Value</span>   |</div><div class="line">+--------------------------------------------------------+---------+</div><div class="line"><span class="localvars">| performance_schema                                     |</span> <span class="class">ON</span>      |</div><div class="line"><span class="localvars">| performance_schema_accounts_size                       |</span> <span class="number">100</span>     |</div><div class="line"><span class="localvars">| performance_schema_digests_size                        |</span> <span class="number">200</span>     |</div><div class="line"><span class="localvars">| performance_schema_events_stages_history_long_size     |</span> <span class="number">10000</span>   |</div><div class="line"><span class="localvars">| performance_schema_events_stages_history_size          |</span> <span class="number">10</span>      |</div><div class="line"><span class="localvars">| performance_schema_events_statements_history_long_size |</span> <span class="number">10000</span>   |</div><div class="line"><span class="localvars">| performance_schema_events_statements_history_size      |</span> <span class="number">10</span>      |</div><div class="line"><span class="localvars">| performance_schema_events_waits_history_long_size      |</span> <span class="number">10000</span>   |</div><div class="line"><span class="localvars">| performance_schema_events_waits_history_size           |</span> <span class="number">10</span>      |</div><div class="line"><span class="localvars">| performance_schema_hosts_size                          |</span> <span class="number">100</span>     |</div><div class="line"><span class="localvars">| performance_schema_max_cond_classes                    |</span> <span class="number">80</span>      |</div><div class="line"><span class="localvars">| performance_schema_max_cond_instances                  |</span> <span class="number">1000</span>    |</div><div class="line">...</div></pre></td></tr></table></figure>

<p>performance_schema ON 和 OFF 表示是否开启和关闭。其他变量表示：表sizes（number of rows）以及内存分配</p>
<blockquote>
<p>一旦开启了performance schema，mysql就会分配内存，这个内存表示最小值，可能会更大，所以<br>需要根据自己的情况设置一个合理的值。</p>
</blockquote>
<p>如果要改变系统变量的值，目前只能在startup阶段修改。如：在my.cnf中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">performance_schema</div><div class="line"><span class="variable">performance_schema_events_waits_history_size=</span><span class="number">20</span></div><div class="line"><span class="variable">performance_schema_events_waits_history_long_size=</span><span class="number">15000</span></div></pre></td></tr></table></figure>

<p>mysql5.6.6 以及以上版本，如果你不显示的设置系统变量，那么mysql自己会设置默认的值。</p>
<h3 id="22-2-3_mysql运行过程中_修改Performance_Schema配置">22.2.3 mysql运行过程中 修改Performance Schema配置</h3>
<p>setup表：如果你有update权限，可以直接更改监控行为。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SELECT TABLE<span class="emphasis">_NAME FROM INFORMATION_</span>SCHEMA.TABLES</div><div class="line"><span class="code">    -&gt; WHERE TABLE_SCHEMA = 'performance_schema'</span></div><div class="line"><span class="header">    -&gt; AND TABLE_NAME LIKE 'setup%';</span></div><div class="line">+-------------------+</div><div class="line"><span class="header">| TABLE_NAME        |</span></div><div class="line">+-------------------+</div><div class="line">| setup<span class="emphasis">_actors      |</span></div><div class="line">| setup_consumers   |</div><div class="line">| setup<span class="emphasis">_instruments |</span></div><div class="line">| setup_objects     |</div><div class="line"><span class="header">| setup_timers      |</span></div><div class="line">+-------------------+</div></pre></td></tr></table></figure>

<p>如果要查看哪些事件选择了哪些时间，可以查看setup_timers</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; SELECT * FROM setup_timers;</span></div><div class="line">+-----------+-------------+</div><div class="line"><span class="header">| NAME      | TIMER_NAME  |</span></div><div class="line">+-----------+-------------+</div><div class="line">| idle      | MICROSECOND |</div><div class="line">| wait      | CYCLE       |</div><div class="line">| stage     | NANOSECOND  |</div><div class="line"><span class="header">| statement | NANOSECOND  |</span></div><div class="line">+-----------+-------------+</div></pre></td></tr></table></figure>

<p>setup_instruments 列出了哪些instrument事件被收集<br>setup_consumers 列出了某一类consumer的instrument事件实际被收集<br>这是一个典型的生产者-消费者模式，即便你设置了setup_instruments=xx，<br>但是如果setup_consumers没有设置对应的内容（即没有消费者），那么实际的instrument<br>也不会收集数据到performance schema的表中。</p>
<h4 id="22-2-3-1_performance_schema事件计时">22.2.3.1 performance_schema事件计时</h4>
<p>计时事件，主要用于提供事件到底话费了多少时间。当然，你也可以配置不开启计时功能。</p>
<p>以下两个表主要提供timer信息：</p>
<ul>
<li>performance_timers: 列出了可用的timers和他们的特点</li>
<li>setup_timers : 描述了哪些instrument对应哪些timers</li>
</ul>
<p>setup_timer是里面的每一条记录都必须是performance_timers里面定义好的内容。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; SELECT * FROM performance_timers;</span></div><div class="line">+-------------+-----------------+------------------+----------------+</div><div class="line"><span class="header">| TIMER_NAME  | TIMER_FREQUENCY | TIMER_RESOLUTION | TIMER_OVERHEAD |</span></div><div class="line">+-------------+-----------------+------------------+----------------+</div><div class="line">| CYCLE       |      2389029850 |                1 |             72 |</div><div class="line">| NANOSECOND  |            NULL |             NULL |           NULL |</div><div class="line">| MICROSECOND |         1000000 |                1 |            585 |</div><div class="line">| MILLISECOND |            1035 |                1 |            738 |</div><div class="line"><span class="header">| TICK        |             101 |                1 |            630 |</span></div><div class="line">+-------------+-----------------+------------------+----------------+</div></pre></td></tr></table></figure>

<p>一般都采用picsecond皮秒 作为基准单位。</p>
<h4 id="22-2-3-2_performance_schema_过滤事件">22.2.3.2 performance_schema 过滤事件</h4>
<p>事件处理是一种典型的生产者-消费者模式</p>
<ul>
<li>Instrument 生产事件，然后被收集。setup_instruments表列出来哪些instrument 可以被收集。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; SELECT * FROM setup_instruments;</span></div><div class="line">+------------------------------------------------------------+---------+-------+</div><div class="line"><span class="header">| NAME                                                       | ENABLED | TIMED |</span></div><div class="line">+------------------------------------------------------------+---------+-------+</div><div class="line"><span class="bullet">...</span></div><div class="line">| wait/synch/mutex/sql/LOCK<span class="emphasis">_global_</span>read<span class="emphasis">_lock                 | YES     | YES   |</span></div><div class="line">| wait/synch/mutex/sql/LOCK_global<span class="emphasis">_system_</span>variables          | YES     | YES   |</div><div class="line">| wait/synch/mutex/sql/LOCK<span class="emphasis">_lock_</span>db                          | YES     | YES   |</div><div class="line">| wait/synch/mutex/sql/LOCK<span class="emphasis">_manager                          | YES     | YES   |</span></div><div class="line">...</div></pre></td></tr></table></figure>

<p>setup_instruments 提供了最基本的形式来控制事件的产生。其他的事件产生形式（如：基于某一个object或者thread）可以参考：Section 22.2.3.3, “Event Pre-Filtering”</p>
<ul>
<li>Performan schema里面的那些表，就是用来事件的目的地和消费事件用的。setup_consumers表列出了很多类型的consumer</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">mysql&gt; <span class="class">SELECT</span> * <span class="class">FROM</span> setup_consumers;</div><div class="line">+--------------------------------+---------+</div><div class="line">| <span class="class">NAME</span>                           | <span class="class">ENABLED</span> |</div><div class="line">+--------------------------------+---------+</div><div class="line"><span class="localvars">| events_stages_current          |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_stages_history          |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_stages_history_long     |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_statements_current      |</span> <span class="class">YES</span>     |</div><div class="line"><span class="localvars">| events_statements_history      |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_statements_history_long |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_waits_current           |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_waits_history           |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| events_waits_history_long      |</span> <span class="class">NO</span>      |</div><div class="line"><span class="localvars">| global_instrumentation         |</span> <span class="class">YES</span>     |</div><div class="line"><span class="localvars">| thread_instrumentation         |</span> <span class="class">YES</span>     |</div><div class="line"><span class="localvars">| statements_digest              |</span> <span class="class">YES</span>     |</div><div class="line">+--------------------------------+---------+</div></pre></td></tr></table></figure>

<p>对于监控事件的过滤分为不同的阶段：</p>
<ul>
<li>Pre-filtering: 修改Performance schema的配置（开启或者关闭相应的 instrument 或者 consumer），可以让一部分事件从生产者中收集然后只影响部分consumer. pre-filtering 完成后<br>会所有用户产生全局影响。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">为什么要使用<span class="keyword">pre</span>-filtering</div><div class="line"></div><div class="line">* 减少负载。 虽然开启所有的事件监控也只会有少许压力负载。 但是你还想竟可能的降低负载，</div><div class="line">比如：你可以关闭一些不用的功能，如计时。</div><div class="line"></div><div class="line">* 避免填充你不关心的current-events <span class="built_in">or</span> <span class="keyword">history</span>表。比如：你只开启了文件相关的instrument，那么那些非文件的记录就不会填充在current-events <span class="built_in">or</span> <span class="keyword">history</span>表中。那么在post-filtering 中，也不会有相关记录。</div><div class="line"></div><div class="line">* 避免维护一些你不关心的事件表。如果你关闭了某些consumer，服务器就不会话费事件来维护consumer对于的destination表。举例：如果你不关心历史记录事件，你就可以关闭 <span class="keyword">history</span> table consumer 来提升性能。</div></pre></td></tr></table></figure>

<ul>
<li>Post-filtering： 需要用到一些查询语句（where子句）来过滤。Post-filtering是基于用户的不同用户不一样。</li>
</ul>
<h4 id="22-2-3-3_Pre-Filtering_事件">22.2.3.3 Pre-Filtering 事件</h4>
<p>Pre-Filtering 既可以用在 producer ， 也可以用在 consumer 中</p>
<ul>
<li><p>配置pre-filtering用在 producer上，主要有这些表</p>
<ul>
<li><p>setup_instruments : 如果对应的instrument关闭了，那么就不会收集对应event的信息，即便是production-related setup 表。</p>
</li>
<li><p>setup_objects : 控制了是否监控特定对象 </p>
</li>
<li><p>threads ： 是否每一个thread都会被监控</p>
</li>
<li><p>setup_actors: 决定了哪些host，user，role的foreground thread被监控。</p>
</li>
</ul>
</li>
<li><p>配置pre-filtering用在 consumer上，主要是setup_consumers 这张表。这决定了被收集的event会被发送的目的地。setup_consumers 也会潜在影响production。如果给定的事件没有被配置发送到任何地方（没有consumer），那么performance schema 也不会produce 它。</p>
</li>
</ul>
<p>修改以上表，基本上都会立刻生效。但是也有一些例外：</p>
<ul>
<li><p>某些setup_instruments 只在server startup阶段生效，即便你在running 阶段设置也是没有用的。<br>他们就是： mutexes, conditions, and rwlocks</p>
</li>
<li><p>setup_actors 只影响foreground thread，并且只会对新进来的thread有影响。已经存在的thread不受影响。</p>
</li>
</ul>
<p>即便你修改了以上配置，performance schema不会flush 信息到history表。原来的记录还是存在current-events and history tables ，直到被新的event替换。关闭instrument，也是一样。<br>当然，你可以truncate table 来情况history历史表。</p>
<p>你也许也想使用truncate 来清空summary类型的表。遗憾的是truncate summary类型的表只会将summary列设置为0或者null，不会删除数据。  events_statements_summary_by_digest例外。</p>
<h5 id="22-2-3-3-1_Pre-Filtering_by_Instrument">22.2.3.3.1 Pre-Filtering by Instrument</h5>
<p>更改立刻生效，部分必须在startup阶段（mutexes, conditions, and rwlocks）</p>
<p>例子：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="subst">*</span> Disable <span class="literal">all</span> instruments:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments <span class="built_in">SET</span> ENABLED <span class="subst">=</span> <span class="string">'NO'</span>;</div><div class="line">Now no events will be collected<span class="built_in">.</span></div><div class="line"></div><div class="line"><span class="subst">*</span> Disable <span class="literal">all</span> file instruments, adding them <span class="keyword">to</span> the current <span class="built_in">set</span> of disabled instruments:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments <span class="built_in">SET</span> ENABLED <span class="subst">=</span> <span class="string">'NO'</span></div><div class="line">    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> NAME LIKE <span class="string">'wait/io/file/%'</span>;</div><div class="line">    </div><div class="line"><span class="subst">*</span> Disable only file instruments, enable <span class="literal">all</span> other instruments:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments</div><div class="line">    <span class="subst">-&gt; </span><span class="built_in">SET</span> ENABLED <span class="subst">=</span> <span class="keyword">IF</span>(NAME LIKE <span class="string">'wait/io/file/%'</span>, <span class="string">'NO'</span>, <span class="string">'YES'</span>);</div><div class="line"></div><div class="line"><span class="subst">*</span> Enable <span class="literal">all</span> but those instruments <span class="keyword">in</span> the mysys library:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments</div><div class="line">    <span class="subst">-&gt; </span><span class="built_in">SET</span> ENABLED <span class="subst">=</span> <span class="keyword">CASE</span> WHEN NAME LIKE <span class="string">'%/mysys/%'</span> THEN <span class="string">'YES'</span> <span class="keyword">ELSE</span> <span class="string">'NO'</span> END;</div><div class="line"></div><div class="line"><span class="subst">*</span> Disable a specific instrument:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments <span class="built_in">SET</span> ENABLED <span class="subst">=</span> <span class="string">'NO'</span></div><div class="line">    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> NAME <span class="subst">=</span> <span class="string">'wait/synch/mutex/mysys/TMPDIR_mutex'</span>;</div><div class="line"></div><div class="line"><span class="subst">*</span> <span class="keyword">To</span> toggle the state of an instrument, “flip” its ENABLED value:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments</div><div class="line">    <span class="subst">-&gt; </span><span class="built_in">SET</span> ENABLED <span class="subst">=</span> <span class="keyword">IF</span>(ENABLED <span class="subst">=</span> <span class="string">'YES'</span>, <span class="string">'NO'</span>, <span class="string">'YES'</span>)</div><div class="line">    <span class="subst">-&gt; </span><span class="keyword">WHERE</span> NAME <span class="subst">=</span> <span class="string">'wait/synch/mutex/mysys/TMPDIR_mutex'</span>;</div><div class="line"></div><div class="line"><span class="subst">*</span> Disable timing for <span class="literal">all</span> events:</div><div class="line"></div><div class="line">mysql<span class="subst">&gt;</span> UPDATE setup_instruments <span class="built_in">SET</span> TIMED <span class="subst">=</span> <span class="string">'NO'</span>;</div></pre></td></tr></table></figure>

<h5 id="22-2-3-3-2_Pre-Filtering_by_Object">22.2.3.3.2 Pre-Filtering by Object</h5>
<p>更改后，立刻生效。</p>
<p>例子1：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="header">mysql&gt; SELECT * FROM setup_objects;</span></div><div class="line">+-------------+--------------------+-------------+---------+-------+</div><div class="line"><span class="header">| OBJECT_TYPE | OBJECT_SCHEMA      | OBJECT_NAME | ENABLED | TIMED |</span></div><div class="line">+-------------+--------------------+-------------+---------+-------+</div><div class="line">| TABLE       | mysql              | %           | NO      | NO    |</div><div class="line">| TABLE       | performance<span class="emphasis">_schema | %           | NO      | NO    |</span></div><div class="line">| TABLE       | information_schema | %           | NO      | NO    |</div><div class="line"><span class="header">| TABLE       | %                  | %           | YES     | YES   |</span></div><div class="line">+-------------+--------------------+-------------+---------+-------+</div></pre></td></tr></table></figure>

<p>例子2：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="code">+-------------+</span>---------------<span class="code">+-------------+</span>---------<span class="code">+-------+</span></div><div class="line"><span class="header">| OBJECT_TYPE | OBJECT_SCHEMA | OBJECT_NAME | ENABLED | TIMED |</span></div><div class="line">+-------------+---------------+-------------+---------+-------+</div><div class="line">| TABLE       | db1           | t1          | YES     | YES   |</div><div class="line">| TABLE       | db1           | t2          | NO      | NO    |</div><div class="line">| TABLE       | db2           | %           | YES     | YES   |</div><div class="line">| TABLE       | db3           | %           | NO      | NO    |</div><div class="line"><span class="header">| TABLE       | %             | %           | YES     | YES   |</span></div><div class="line">+-------------+---------------+-------------+---------+-------+</div></pre></td></tr></table></figure>

<h5 id="22-2-3-3-3_Pre-Filtering_by_Thread">22.2.3.3.3 Pre-Filtering by Thread</h5>
<p>略。。。</p>
<h5 id="22-2-3-3-4_Pre-Filtering_by_Consumer">22.2.3.3.4 Pre-Filtering by Consumer</h5>
<p>配置修改，立刻生效</p>
<p>关于setup_consumer 的几个基本原则：</p>
<ul>
<li><p>和consumer相关的destination 不会接收任何event，除非对于的consumer都开启了</p>
</li>
<li><p>consumer只有等待他所依赖的consumer都enable，才会被check。</p>
</li>
<li><p>如果一个consumer没有被checked通过，或者check了，但是被disable了，那么依赖它的那些consumer不会被check.</p>
</li>
<li><p>如果一个event没有对应的destination（没有对应的consumer），那么会被自动disable.</p>
</li>
</ul>
<p>以下列出consumer的等级关系图：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">global_instrumentation</span> <span class="comment">							</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">1</span> <span class="comment">level</span></div><div class="line"> <span class="comment">	thread_instrumentation</span> <span class="comment">						</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">2</span> <span class="comment">level</span></div><div class="line">   <span class="comment">		events_waits_current</span>  <span class="comment">					</span>    <span class="literal">-</span><span class="literal">-</span><span class="comment">3</span> <span class="comment">level</span></div><div class="line">     <span class="comment">		events_waits_history</span>  <span class="comment">				</span>      <span class="literal">-</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">level</span></div><div class="line">     <span class="comment">		events_waits_history_long		</span>          <span class="literal">-</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">level</span></div><div class="line">   <span class="comment">		events_stages_current</span>  <span class="comment">					</span>    <span class="literal">-</span><span class="literal">-</span><span class="comment">3</span> <span class="comment">level</span></div><div class="line">     <span class="comment">		events_stages_history</span> <span class="comment">				</span>      <span class="literal">-</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">level</span></div><div class="line">     <span class="comment">		events_stages_history_long			</span>      <span class="literal">-</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">level</span></div><div class="line">   <span class="comment">		events_statements_current</span> <span class="comment">				</span>    <span class="literal">-</span><span class="literal">-</span><span class="comment">3</span> <span class="comment">level</span></div><div class="line">     <span class="comment">		events_statements_history			</span>      <span class="literal">-</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">level</span> </div><div class="line">    <span class="comment">		events_statements_history_long</span> <span class="comment">		</span>      <span class="literal">-</span><span class="literal">-</span><span class="comment">4</span> <span class="comment">level</span></div><div class="line"><span class="comment">	</span> <span class="comment">statements_digest</span> <span class="comment">							</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">2</span> <span class="comment">level</span></div></pre></td></tr></table></figure>

<h5 id="22-2-3-3-5_Example_Consumer_Configurations">22.2.3.3.5 Example Consumer Configurations</h5>
<p>略。。。</p>
<h2 id="22-3_Performance_Schema_Queries">22.3 Performance Schema Queries</h2>
<p>也就是post-filtering，只不过多了where 从句</p>
<h2 id="22-4_Performance_Schema_Instrument命名规则">22.4 Performance Schema Instrument命名规则</h2>
<p>名字基本都由‘/’分割，从左到右基本都是从普通粒度到精细粒度。</p>
<ul>
<li><p><strong>最上层的instrument 组件</strong></p>
<ul>
<li>idle</li>
<li>stage</li>
<li>statement</li>
<li>wait</li>
</ul>
</li>
<li><p><strong>idle instrument 组件</strong></p>
</li>
</ul>
<p>idle event描述来自：socket_instances.STATE 列： Section 22.9.3.5, “The socket_instances Table”.</p>
<ul>
<li><strong>stage instrument 组件</strong></li>
</ul>
<p>组成形式： stage/code_area/stage_name ， code_area 一般是sql or myisam。<br>stage name 一般来自： SHOW PROCESSLIST，如：Sorting result ，Sending data</p>
<ul>
<li><p><strong>Statement instrument 组件</strong></p>
<ul>
<li><p>statement/abstract/* ： 一般都是早期的stage，在抽象sql都还没来得及解析的时候。</p>
</li>
<li><p>statement/com:  SQL 命令操作 如：statement/com/Connect</p>
</li>
<li><p>statement/sql： SQL语句操作 如：statement/sql/create_db</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>Wait Instrument组件</strong></p>
<ul>
<li><p>wait/io ： IO 等待事件</p>
<ul>
<li><p>wait/io/file ： 文件IO等待事件。等待文件操作完成的时间如：fwrite（）。<br>但是物理IO有可能因为缓存的原因调用fwrite时不会写磁盘。</p>
</li>
<li><p>wait/io/socket： socket相关的IO等待</p>
</li>
<li><p>wait/io/table ： 表相关的IO等待。一般对于记录rows来说有fetch，insert，update，delete四种操作。<br>不像其他等待事件，table I/O 还包含了其他的等待事件。比如：table io可能包含了文件IO和内存IO。因为读取table rows的时候，有可能会去从文件读取数据。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code><span class="keyword">*</span> wait/lock

    <span class="keyword">*</span> wait/lock/table ： 表操作的锁等待事件

<span class="keyword">*</span> wait/synch

    <span class="keyword">*</span> wait/synch/cond ：condition就是线程与线程之间的信号。

    <span class="keyword">*</span> wait/synch/mutex ： mutex主要用来锁住一块共享资源。

    <span class="keyword">*</span> wait/synch/rwlock ： 读写锁
</code></pre><h2 id="22-5_performance_schema_状态监控">22.5 performance schema 状态监控</h2>
<ul>
<li><strong>SHOW STATUS LIKE ‘perf%’</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW STATUS LIKE 'perf%';</div><div class="line">+-----------------------------------------------+-------+</div><div class="line"><span class="string">| Variable_name                                 | Value |</span></div><div class="line">+-----------------------------------------------+-------+</div><div class="line"><span class="string">| Performance_schema_accounts_lost              | 0     |</span></div><div class="line"><span class="string">| Performance_schema_cond_classes_lost          | 0     |</span></div><div class="line"><span class="string">| Performance_schema_cond_instances_lost        | 0     |</span></div><div class="line"><span class="string">| Performance_schema_digest_lost                | 0     |</span></div><div class="line"><span class="string">| Performance_schema_file_classes_lost          | 0     |</span></div><div class="line"><span class="string">| Performance_schema_file_handles_lost          | 0     |</span></div><div class="line"><span class="string">| Performance_schema_file_instances_lost        | 0     |</span></div><div class="line"><span class="string">| Performance_schema_hosts_lost                 | 0     |</span></div><div class="line"><span class="string">| Performance_schema_locker_lost                | 0     |</span></div><div class="line"><span class="string">| Performance_schema_mutex_classes_lost         | 0     |</span></div><div class="line"><span class="string">| Performance_schema_mutex_instances_lost       | 0     |</span></div><div class="line"><span class="string">| Performance_schema_rwlock_classes_lost        | 0     |</span></div><div class="line"><span class="string">| Performance_schema_rwlock_instances_lost      | 0     |</span></div><div class="line"><span class="string">| Performance_schema_session_connect_attrs_lost | 0     |</span></div><div class="line"><span class="string">| Performance_schema_socket_classes_lost        | 0     |</span></div><div class="line"><span class="string">| Performance_schema_socket_instances_lost      | 0     |</span></div><div class="line"><span class="string">| Performance_schema_stage_classes_lost         | 0     |</span></div><div class="line"><span class="string">| Performance_schema_statement_classes_lost     | 0     |</span></div><div class="line"><span class="string">| Performance_schema_table_handles_lost         | 0     |</span></div><div class="line"><span class="string">| Performance_schema_table_instances_lost       | 0     |</span></div><div class="line"><span class="string">| Performance_schema_thread_classes_lost        | 0     |</span></div><div class="line"><span class="string">| Performance_schema_thread_instances_lost      | 0     |</span></div><div class="line"><span class="string">| Performance_schema_users_lost                 | 0     |</span></div><div class="line">+-----------------------------------------------+-------+</div></pre></td></tr></table></figure>

<p>这些状态表明了由于内存限制，有哪些instrument不能被load或者create。</p>
<ul>
<li><strong>SHOW ENGINE PERFORMANCE_SCHEMA STATUS</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW ENGINE PERFORMANCE_SCHEMA STATUS\G</div><div class="line">...</div><div class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> 3. row <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></div><div class="line">  Type: performance_schema</div><div class="line">  Name: events_waits_history.row_size</div><div class="line">Status: 76</div><div class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> 4. row <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></div><div class="line">  Type: performance_schema</div><div class="line">  Name: events_waits_history.row_count</div><div class="line">Status: 10000</div><div class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> 5. row <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></div><div class="line">  Type: performance_schema</div><div class="line">  Name: events_waits_history.memory</div><div class="line">Status: 760000</div><div class="line">...</div><div class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span> 57. row <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></div><div class="line">  Type: performance_schema</div><div class="line">  Name: performance_schema.memory</div><div class="line">Status: 26459600</div><div class="line">...</div></pre></td></tr></table></figure>

<p>这个可以查看status的最大值（.size），以及当前以及达到多少量了（.count）</p>
<p>如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="localvars">| performance_schema |</span> (table_share_hash).count | <span class="number">12391</span>     |</div><div class="line"><span class="localvars">| performance_schema |</span> (table_share_hash).size  | <span class="number">12500</span>     |</div></pre></td></tr></table></figure>

<p>使用心得： 当(table_share_hash).count=(table_share_hash).size，那么就会增加Performance_schema_table_instances_lost的值。这样新的表监控就不会被collect。这时候<br>可以drop 掉一些不用的表，那么(table_share_hash).count 就会下降。</p>
<h2 id="22-8_Performance_Schema_General_Table_Characteristics">22.8 Performance Schema General Table Characteristics</h2>
<p>基本表只允许truncate，select，其他操作都不允许。</p>
<h2 id="最后注意事项">最后注意事项</h2>
<hr>
<ul>
<li><p><strong>variables目前只能重启才能重新配置</strong></p>
</li>
<li><p><strong>重启mysql后，所有状态都会重置</strong></p>
</li>
</ul>
<h2 id="实战">实战</h2>
<hr>
<h3 id="1)_源码：https://github-com/MarkLeith/mysql-sys/">1) 源码：<a href="https://github.com/MarkLeith/mysql-sys/" target="_blank" rel="external">https://github.com/MarkLeith/mysql-sys/</a></h3>
<h3 id="2）这里面的代码参考Mark_leith，有部分做过修改，也有部分对线上影响非常大。">2）这里面的代码参考Mark leith，有部分做过修改，也有部分对线上影响非常大。</h3>
<h3 id="3）对所有view都做过详细解释与实战测试，有部分坑里面说明">3）对所有view都做过详细解释与实战测试，有部分坑里面说明</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div><div class="line">953</div><div class="line">954</div><div class="line">955</div><div class="line">956</div><div class="line">957</div><div class="line">958</div><div class="line">959</div><div class="line">960</div><div class="line">961</div><div class="line">962</div><div class="line">963</div><div class="line">964</div><div class="line">965</div><div class="line">966</div><div class="line">967</div><div class="line">968</div><div class="line">969</div><div class="line">970</div><div class="line">971</div><div class="line">972</div><div class="line">973</div><div class="line">974</div><div class="line">975</div><div class="line">976</div><div class="line">977</div><div class="line">978</div><div class="line">979</div><div class="line">980</div><div class="line">981</div><div class="line">982</div><div class="line">983</div><div class="line">984</div><div class="line">985</div><div class="line">986</div><div class="line">987</div><div class="line">988</div><div class="line">989</div><div class="line">990</div><div class="line">991</div><div class="line">992</div><div class="line">993</div><div class="line">994</div><div class="line">995</div><div class="line">996</div><div class="line">997</div><div class="line">998</div><div class="line">999</div><div class="line">1000</div><div class="line">1001</div><div class="line">1002</div><div class="line">1003</div><div class="line">1004</div><div class="line">1005</div><div class="line">1006</div><div class="line">1007</div><div class="line">1008</div><div class="line">1009</div><div class="line">1010</div><div class="line">1011</div><div class="line">1012</div><div class="line">1013</div><div class="line">1014</div><div class="line">1015</div><div class="line">1016</div><div class="line">1017</div><div class="line">1018</div><div class="line">1019</div><div class="line">1020</div><div class="line">1021</div><div class="line">1022</div><div class="line">1023</div><div class="line">1024</div><div class="line">1025</div><div class="line">1026</div><div class="line">1027</div><div class="line">1028</div><div class="line">1029</div><div class="line">1030</div><div class="line">1031</div><div class="line">1032</div><div class="line">1033</div><div class="line">1034</div><div class="line">1035</div><div class="line">1036</div><div class="line">1037</div><div class="line">1038</div><div class="line">1039</div><div class="line">1040</div><div class="line">1041</div><div class="line">1042</div><div class="line">1043</div><div class="line">1044</div><div class="line">1045</div><div class="line">1046</div><div class="line">1047</div><div class="line">1048</div><div class="line">1049</div><div class="line">1050</div><div class="line">1051</div><div class="line">1052</div><div class="line">1053</div><div class="line">1054</div><div class="line">1055</div><div class="line">1056</div><div class="line">1057</div><div class="line">1058</div><div class="line">1059</div><div class="line">1060</div><div class="line">1061</div><div class="line">1062</div><div class="line">1063</div><div class="line">1064</div><div class="line">1065</div><div class="line">1066</div><div class="line">1067</div><div class="line">1068</div><div class="line">1069</div><div class="line">1070</div><div class="line">1071</div><div class="line">1072</div><div class="line">1073</div><div class="line">1074</div><div class="line">1075</div><div class="line">1076</div><div class="line">1077</div><div class="line">1078</div><div class="line">1079</div><div class="line">1080</div><div class="line">1081</div><div class="line">1082</div><div class="line">1083</div><div class="line">1084</div><div class="line">1085</div><div class="line">1086</div><div class="line">1087</div><div class="line">1088</div><div class="line">1089</div><div class="line">1090</div><div class="line">1091</div><div class="line">1092</div><div class="line">1093</div><div class="line">1094</div><div class="line">1095</div><div class="line">1096</div><div class="line">1097</div><div class="line">1098</div><div class="line">1099</div><div class="line">1100</div><div class="line">1101</div><div class="line">1102</div><div class="line">1103</div><div class="line">1104</div><div class="line">1105</div><div class="line">1106</div><div class="line">1107</div><div class="line">1108</div><div class="line">1109</div><div class="line">1110</div><div class="line">1111</div><div class="line">1112</div><div class="line">1113</div><div class="line">1114</div><div class="line">1115</div><div class="line">1116</div><div class="line">1117</div><div class="line">1118</div><div class="line">1119</div><div class="line">1120</div><div class="line">1121</div><div class="line">1122</div><div class="line">1123</div><div class="line">1124</div><div class="line">1125</div><div class="line">1126</div><div class="line">1127</div><div class="line">1128</div><div class="line">1129</div><div class="line">1130</div><div class="line">1131</div><div class="line">1132</div><div class="line">1133</div><div class="line">1134</div><div class="line">1135</div><div class="line">1136</div><div class="line">1137</div><div class="line">1138</div><div class="line">1139</div><div class="line">1140</div><div class="line">1141</div><div class="line">1142</div><div class="line">1143</div><div class="line">1144</div><div class="line">1145</div><div class="line">1146</div><div class="line">1147</div><div class="line">1148</div><div class="line">1149</div><div class="line">1150</div><div class="line">1151</div><div class="line">1152</div><div class="line">1153</div><div class="line">1154</div><div class="line">1155</div><div class="line">1156</div><div class="line">1157</div><div class="line">1158</div><div class="line">1159</div><div class="line">1160</div><div class="line">1161</div><div class="line">1162</div><div class="line">1163</div><div class="line">1164</div><div class="line">1165</div><div class="line">1166</div><div class="line">1167</div><div class="line">1168</div><div class="line">1169</div><div class="line">1170</div><div class="line">1171</div><div class="line">1172</div><div class="line">1173</div><div class="line">1174</div><div class="line">1175</div><div class="line">1176</div><div class="line">1177</div><div class="line">1178</div><div class="line">1179</div><div class="line">1180</div><div class="line">1181</div><div class="line">1182</div><div class="line">1183</div><div class="line">1184</div><div class="line">1185</div><div class="line">1186</div><div class="line">1187</div><div class="line">1188</div><div class="line">1189</div><div class="line">1190</div><div class="line">1191</div><div class="line">1192</div><div class="line">1193</div><div class="line">1194</div><div class="line">1195</div><div class="line">1196</div><div class="line">1197</div><div class="line">1198</div><div class="line">1199</div><div class="line">1200</div><div class="line">1201</div><div class="line">1202</div><div class="line">1203</div><div class="line">1204</div><div class="line">1205</div><div class="line">1206</div><div class="line">1207</div><div class="line">1208</div><div class="line">1209</div><div class="line">1210</div><div class="line">1211</div><div class="line">1212</div><div class="line">1213</div><div class="line">1214</div><div class="line">1215</div><div class="line">1216</div><div class="line">1217</div><div class="line">1218</div><div class="line">1219</div><div class="line">1220</div><div class="line">1221</div><div class="line">1222</div><div class="line">1223</div><div class="line">1224</div><div class="line">1225</div><div class="line">1226</div><div class="line">1227</div><div class="line">1228</div><div class="line">1229</div><div class="line">1230</div><div class="line">1231</div><div class="line">1232</div><div class="line">1233</div><div class="line">1234</div><div class="line">1235</div><div class="line">1236</div><div class="line">1237</div><div class="line">1238</div><div class="line">1239</div><div class="line">1240</div><div class="line">1241</div><div class="line">1242</div><div class="line">1243</div><div class="line">1244</div><div class="line">1245</div><div class="line">1246</div><div class="line">1247</div><div class="line">1248</div><div class="line">1249</div><div class="line">1250</div><div class="line">1251</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">* 所涉及的performance_schema的所有列表</div><div class="line">* <span class="number">1</span>）file_summary_by_instance</div><div class="line">* <span class="number">2</span>) file_summary_by_event_name</div><div class="line">* <span class="number">3</span>) table_io_waits_summary_by_index_usage</div><div class="line">* <span class="number">4</span>) events_statements_summary_by_digest</div><div class="line">* <span class="number">5</span>) events_statements_summary_by_host_by_event_name</div><div class="line">* <span class="number">6</span>) events_statements_summary_global_by_event_name</div><div class="line">* <span class="number">7</span>) events_waits_summary_global_by_event_name</div><div class="line">* <span class="number">8</span>) events_waits_summary_by_host_by_event_name </div><div class="line">* <span class="number">9</span>) objects_summary_global_by_type</div><div class="line">* <span class="number">10</span>) </div><div class="line">*/</div><div class="line"></div><div class="line">/*</div><div class="line">*	Create DATABASE v_monitor</div><div class="line">*/</div><div class="line">CREATE DATABASE <span class="keyword">IF</span> <span class="keyword">NOT</span> EXISTS v_monitor <span class="keyword">DEFAULT</span> CHARACTER <span class="keyword">SET</span> utf8;</div><div class="line">USE v_monitor;</div><div class="line"></div><div class="line">/*</div><div class="line">*	Create <span class="keyword">function</span> format_time</div><div class="line">*/</div><div class="line"></div><div class="line">DROP <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> EXISTS format_time;</div><div class="line"></div><div class="line">DELIMITER $$</div><div class="line"></div><div class="line">CREATE DEFINER=<span class="comment">'xxx'@'%'  FUNCTION format_time (</span></div><div class="line">        picoseconds BIGINT UNSIGNED</div><div class="line">    )</div><div class="line">    RETURNS VARCHAR(<span class="number">16</span>) CHARSET UTF8</div><div class="line">    SQL SECURITY INVOKER</div><div class="line">    DETERMINISTIC</div><div class="line">    NO SQL</div><div class="line">BEGIN</div><div class="line">  <span class="keyword">IF</span> picoseconds <span class="keyword">IS</span> NULL <span class="keyword">THEN</span> <span class="keyword">RETURN</span> NULL;</div><div class="line">  <span class="keyword">ELSEIF</span> picoseconds &gt;= <span class="number">3600000000000000</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(picoseconds / <span class="number">3600000000000000</span>, <span class="number">2</span>), <span class="comment">'h');</span></div><div class="line">  <span class="keyword">ELSEIF</span> picoseconds &gt;= <span class="number">60000000000000</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> SEC_TO_TIME(ROUND(picoseconds / <span class="number">1000000000000</span>, <span class="number">2</span>));</div><div class="line">  <span class="keyword">ELSEIF</span> picoseconds &gt;= <span class="number">1000000000000</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(picoseconds / <span class="number">1000000000000</span>, <span class="number">2</span>), <span class="comment">' s');</span></div><div class="line">  <span class="keyword">ELSEIF</span> picoseconds &gt;= <span class="number">1000000000</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(picoseconds / <span class="number">1000000000</span>, <span class="number">2</span>), <span class="comment">' ms');</span></div><div class="line">  <span class="keyword">ELSEIF</span> picoseconds &gt;= <span class="number">1000000</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(picoseconds / <span class="number">1000000</span>, <span class="number">2</span>), <span class="comment">' us');</span></div><div class="line">  <span class="keyword">ELSEIF</span> picoseconds &gt;= <span class="number">1000</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(picoseconds / <span class="number">1000</span>, <span class="number">2</span>), <span class="comment">' ns');</span></div><div class="line">  <span class="keyword">ELSE</span> <span class="keyword">RETURN</span> CONCAT(picoseconds, <span class="comment">' ps');</span></div><div class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line"><span class="keyword">END</span> $$</div><div class="line"></div><div class="line">DELIMITER ;</div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">*	Create <span class="keyword">function</span> format_statement</div><div class="line">*/</div><div class="line"></div><div class="line">DROP <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> EXISTS format_statement;</div><div class="line"></div><div class="line">DELIMITER $$</div><div class="line"></div><div class="line">CREATE DEFINER=<span class="comment">'xxx'@'%'  FUNCTION format_statement (</span></div><div class="line">        statement LONGTEXT</div><div class="line">    )</div><div class="line">    RETURNS VARCHAR(<span class="number">65</span>)</div><div class="line">    SQL SECURITY INVOKER</div><div class="line">    DETERMINISTIC</div><div class="line">    NO SQL</div><div class="line">BEGIN</div><div class="line">  <span class="keyword">IF</span> LENGTH(statement) &gt; <span class="number">64</span> <span class="keyword">THEN</span> </div><div class="line">      <span class="keyword">RETURN</span> REPLACE(CONCAT(LEFT(statement, <span class="number">30</span>), <span class="comment">' ... ', RIGHT(statement, 30)), '\n', ' ');</span></div><div class="line">  <span class="keyword">ELSE</span> </div><div class="line">      <span class="keyword">RETURN</span> REPLACE(statement, <span class="comment">'\n', ' ');</span></div><div class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line"><span class="keyword">END</span> $$</div><div class="line"></div><div class="line">DELIMITER ;</div><div class="line"></div><div class="line">/*</div><div class="line">*	Create <span class="keyword">function</span> format_bytes</div><div class="line">*/</div><div class="line"></div><div class="line"></div><div class="line">DROP <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> EXISTS format_bytes;</div><div class="line"></div><div class="line">DELIMITER $$</div><div class="line"></div><div class="line">CREATE DEFINER=<span class="comment">'xxx'@'%'  FUNCTION format_bytes (</span></div><div class="line">        bytes BIGINT</div><div class="line">    )</div><div class="line">    RETURNS VARCHAR(<span class="number">16</span>)</div><div class="line">    SQL SECURITY INVOKER</div><div class="line">    DETERMINISTIC</div><div class="line">    NO SQL</div><div class="line">BEGIN</div><div class="line">  <span class="keyword">IF</span> bytes <span class="keyword">IS</span> NULL <span class="keyword">THEN</span> <span class="keyword">RETURN</span> NULL;</div><div class="line">  <span class="keyword">ELSEIF</span> bytes &gt;= <span class="number">1125899906842624</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(bytes / <span class="number">1125899906842624</span>, <span class="number">2</span>), <span class="comment">' PiB');</span></div><div class="line">  <span class="keyword">ELSEIF</span> bytes &gt;= <span class="number">1099511627776</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(bytes / <span class="number">1099511627776</span>, <span class="number">2</span>), <span class="comment">' TiB');</span></div><div class="line">  <span class="keyword">ELSEIF</span> bytes &gt;= <span class="number">1073741824</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(bytes / <span class="number">1073741824</span>, <span class="number">2</span>), <span class="comment">' GiB');</span></div><div class="line">  <span class="keyword">ELSEIF</span> bytes &gt;= <span class="number">1048576</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(bytes / <span class="number">1048576</span>, <span class="number">2</span>), <span class="comment">' MiB');</span></div><div class="line">  <span class="keyword">ELSEIF</span> bytes &gt;= <span class="number">1024</span> <span class="keyword">THEN</span> <span class="keyword">RETURN</span> CONCAT(ROUND(bytes / <span class="number">1024</span>, <span class="number">2</span>), <span class="comment">' KiB');</span></div><div class="line">  <span class="keyword">ELSE</span> <span class="keyword">RETURN</span> CONCAT(bytes, <span class="comment">' bytes');</span></div><div class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line"><span class="keyword">END</span> $$</div><div class="line"></div><div class="line">DELIMITER ;</div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">*	Create <span class="keyword">function</span> format_path</div><div class="line">*/</div><div class="line"></div><div class="line">DROP <span class="keyword">FUNCTION</span> <span class="keyword">IF</span> EXISTS format_path;</div><div class="line"></div><div class="line">DELIMITER $$</div><div class="line"></div><div class="line">CREATE DEFINER=<span class="comment">'xxx'@'%'  FUNCTION format_path (</span></div><div class="line">        path VARCHAR(<span class="number">260</span>)</div><div class="line">    )</div><div class="line">    RETURNS VARCHAR(<span class="number">260</span>) CHARSET UTF8</div><div class="line">    SQL SECURITY INVOKER</div><div class="line">    DETERMINISTIC</div><div class="line">    NO SQL</div><div class="line">BEGIN</div><div class="line">  <span class="keyword">DECLARE</span> v_path VARCHAR(<span class="number">260</span>);</div><div class="line"></div><div class="line">  </div><div class="line">  <span class="keyword">IF</span> path <span class="keyword">LIKE</span> <span class="comment">'/private/%' </span></div><div class="line">    <span class="keyword">THEN</span> <span class="keyword">SET</span> v_path = REPLACE(path, <span class="comment">'/private', '');</span></div><div class="line">    <span class="keyword">ELSE</span> <span class="keyword">SET</span> v_path = path;</div><div class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line"></div><div class="line">  <span class="keyword">IF</span> v_path <span class="keyword">IS</span> NULL <span class="keyword">THEN</span> <span class="keyword">RETURN</span> NULL;</div><div class="line">  <span class="keyword">ELSEIF</span> v_path <span class="keyword">LIKE</span> CONCAT(@@<span class="keyword">global</span>.datadir, <span class="comment">'%') ESCAPE '|' THEN </span></div><div class="line">    <span class="keyword">RETURN</span> REPLACE(REPLACE(REPLACE(v_path, @@<span class="keyword">global</span>.datadir, <span class="comment">'@@datadir/'), '\\\\', ''), '\\', '/');</span></div><div class="line">  <span class="keyword">ELSEIF</span> v_path <span class="keyword">LIKE</span> CONCAT(@@<span class="keyword">global</span>.tmpdir, <span class="comment">'%') ESCAPE '|' THEN </span></div><div class="line">    <span class="keyword">RETURN</span> REPLACE(REPLACE(REPLACE(v_path, @@<span class="keyword">global</span>.tmpdir, <span class="comment">'@@tmpdir/'), '\\\\', ''), '\\', '/');</span></div><div class="line">  <span class="keyword">ELSE</span> <span class="keyword">RETURN</span> v_path;</div><div class="line">  <span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line"><span class="keyword">END</span>$$</div><div class="line"></div><div class="line">DELIMITER ;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">*	IO 相关，文件相关的延迟 ， 事件相关的延迟， FILE IO</div><div class="line">*   View: io_global_by_file_by_bytes</div><div class="line">* 	使用说明： 统计每个文件的IO使用率, 比如读写次数，读写bytes	</div><div class="line">*   能解决什么问题？</div><div class="line">*	<span class="number">1</span>）可以清楚的知道那个文件是被访问的最频繁，压力最大，延迟最多的文件。</div><div class="line">*	<span class="number">2</span>）可以实时监控redo log，undo，datafile的变化，从而做针对性的优化和调整。当然，通过这个，也能知道瓶颈。</div><div class="line">*	<span class="number">3</span>）可以清楚的知道某个库级别，表级别的压力情况，这个比之前count sql数量，观察data size要靠谱，真实的多。</div><div class="line">*	<span class="number">4</span>）可以做前瞻性的规划，比如：拆库拆表，可以指导如何按照压力负载均衡的做到合理来优化拆分</div><div class="line">*	<span class="number">5</span>）通过表级别的count监控，还可以用做前端缓存的利用率监控。</div><div class="line">*   <span class="number">6</span>）可以知道哪些db.table是以只读为主，哪些db.test是以只写为主。从而又进一步做缓存和业务监控。</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> io_global_by_file_by_bytes limit <span class="number">10</span>;</div><div class="line">*+--------------------------------------------------+------------+------------+-------------+---------------+------------+</div><div class="line">*| file                                             | count_read | total_read | count_write | total_written | total      |</div><div class="line">*+--------------------------------------------------+------------+------------+-------------+---------------+------------+</div><div class="line">*| /data/mysql/var/ibdata1                          |          <span class="number">0</span> | <span class="number">0</span> bytes    |    <span class="number">16952506</span> | <span class="number">880.15</span> GiB    | <span class="number">880.15</span> GiB |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_hour_11.ibd  |          <span class="number">0</span> | <span class="number">0</span> bytes    |     <span class="number">8782380</span> | <span class="number">140.21</span> GiB    | <span class="number">140.21</span> GiB |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_hour_oth.ibd |          <span class="number">0</span> | <span class="number">0</span> bytes    |     <span class="number">5631256</span> | <span class="number">89.36</span> GiB     | <span class="number">89.36</span> GiB  |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_day_11.ibd   |          <span class="number">0</span> | <span class="number">0</span> bytes    |     <span class="number">5017652</span> | <span class="number">80.69</span> GiB     | <span class="number">80.69</span> GiB  |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_11.ibd       |          <span class="number">0</span> | <span class="number">0</span> bytes    |     <span class="number">3692307</span> | <span class="number">60.88</span> GiB     | <span class="number">60.88</span> GiB  |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_day_oth.ibd  |          <span class="number">0</span> | <span class="number">0</span> bytes    |     <span class="number">2999151</span> | <span class="number">49.81</span> GiB     | <span class="number">49.81</span> GiB  |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_oth.ibd      |          <span class="number">0</span> | <span class="number">0</span> bytes    |     <span class="number">2103639</span> | <span class="number">36.41</span> GiB     | <span class="number">36.41</span> GiB  |</div><div class="line">*| /data/mysql/var/ib_logfile0                      |          <span class="number">0</span> | <span class="number">0</span> bytes    |    <span class="number">29454850</span> | <span class="number">21.94</span> GiB     | <span class="number">21.94</span> GiB  |</div><div class="line">*| /data/mysql/var/ib_logfile1                      |          <span class="number">0</span> | <span class="number">0</span> bytes    |    <span class="number">29102130</span> | <span class="number">21.60</span> GiB     | <span class="number">21.60</span> GiB  |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_click_oth.ibd      |          <span class="number">0</span> | <span class="number">0</span> bytes    |      <span class="number">898190</span> | <span class="number">14.53</span> GiB     | <span class="number">14.53</span> GiB  |</div><div class="line">*+--------------------------------------------------+------------+------------+-------------+---------------+------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line">*/</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW io_global_by_file_by_bytes (</div><div class="line">  file,</div><div class="line">  count_read,</div><div class="line">  total_read,</div><div class="line">  count_write,</div><div class="line">  total_written,</div><div class="line">  total</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> v_monitor.format_path(file_name) <span class="keyword">AS</span> file, </div><div class="line">       count_read, </div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_read) <span class="keyword">AS</span> total_read,</div><div class="line">       count_write, </div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_write) <span class="keyword">AS</span> total_written,</div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_read + sum_number_of_bytes_write) <span class="keyword">AS</span> total</div><div class="line">  <span class="keyword">FROM</span> performance_schema.file_summary_by_instance</div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_number_of_bytes_read + sum_number_of_bytes_write DESC;</div><div class="line"></div><div class="line">/*</div><div class="line"> 	* 未经过转换的原始信息</div><div class="line">*/</div><div class="line"></div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW origin_io_global_by_file_by_bytes (</div><div class="line">   file,</div><div class="line">   count_read,</div><div class="line">   total_read,</div><div class="line">   count_write,</div><div class="line">   total_written,</div><div class="line">   total</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> v_monitor.format_path(file_name) <span class="keyword">AS</span> file, </div><div class="line">        count_read, </div><div class="line">        sum_number_of_bytes_read <span class="keyword">AS</span> total_read,</div><div class="line">        count_write, </div><div class="line">        sum_number_of_bytes_write <span class="keyword">AS</span> total_written,</div><div class="line">        sum_number_of_bytes_read + sum_number_of_bytes_write <span class="keyword">AS</span> total</div><div class="line">   <span class="keyword">FROM</span> performance_schema.file_summary_by_instance</div><div class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_number_of_bytes_read + sum_number_of_bytes_write DESC;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">*	IO 相关，文件相关的延迟 ， 事件相关的延迟 FILE IO</div><div class="line">*   View: io_global_by_file_by_latency</div><div class="line">* 	使用说明： 统计每个文件的latency  	</div><div class="line">*   能解决什么问题？</div><div class="line">*   <span class="number">1</span>）能解决的问题和io_global_by_file_by_bytes一样，只不过角度不一样。这里是以延迟来衡量</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> io_global_by_file_by_latency limit <span class="number">10</span>;</div><div class="line">*+--------------------------------------------------+----------+---------------+------------+--------------+-------------+---------------+</div><div class="line">*| file                                             | total    | total_latency | count_read | read_latency | count_write | write_latency |</div><div class="line">*+--------------------------------------------------+----------+---------------+------------+--------------+-------------+---------------+</div><div class="line">*| /data/mysql/var/ib_logfile0                      | <span class="number">59328704</span> | <span class="number">1.40</span>h         |          <span class="number">0</span> | <span class="number">0</span> ps         |    <span class="number">29670415</span> | <span class="number">00</span>:<span class="number">03</span>:<span class="number">05.51</span>   |</div><div class="line">*| /data/mysql/var/ib_logfile1                      | <span class="number">58204245</span> | <span class="number">1.38</span>h         |          <span class="number">0</span> | <span class="number">0</span> ps         |    <span class="number">29102130</span> | <span class="number">00</span>:<span class="number">03</span>:<span class="number">01.40</span>   |</div><div class="line">*| /data/mysql/var/ibdata1                          | <span class="number">18492358</span> | <span class="number">00</span>:<span class="number">54</span>:<span class="number">07.96</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |    <span class="number">17039981</span> | <span class="number">00</span>:<span class="number">06</span>:<span class="number">49.20</span>   |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_hour_11.ibd  |  <span class="number">9369453</span> | <span class="number">00</span>:<span class="number">08</span>:<span class="number">23.82</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |     <span class="number">8832634</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">19.78</span>   |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_day_11.ibd   |  <span class="number">5548183</span> | <span class="number">00</span>:<span class="number">05</span>:<span class="number">52.43</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |     <span class="number">5052084</span> | <span class="number">45.78</span> s       |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_hour_oth.ibd |  <span class="number">6172184</span> | <span class="number">00</span>:<span class="number">05</span>:<span class="number">46.43</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |     <span class="number">5667656</span> | <span class="number">54.00</span> s       |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_11.ibd       |  <span class="number">4126313</span> | <span class="number">00</span>:<span class="number">04</span>:<span class="number">59.54</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |     <span class="number">3717949</span> | <span class="number">32.73</span> s       |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_oth.ibd      |  <span class="number">2376313</span> | <span class="number">00</span>:<span class="number">04</span>:<span class="number">14.98</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |     <span class="number">2116758</span> | <span class="number">17.49</span> s       |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_stats_day_oth.ibd  |  <span class="number">3412908</span> | <span class="number">00</span>:<span class="number">03</span>:<span class="number">58.03</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |     <span class="number">3018950</span> | <span class="number">26.98</span> s       |</div><div class="line">*| /data/mysql/var/ark_db/hp_pro_click_oth.ibd      |  <span class="number">1101398</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">12.65</span>   |          <span class="number">0</span> | <span class="number">0</span> ps         |      <span class="number">902427</span> | <span class="number">9.63</span> s        |</div><div class="line">*+--------------------------------------------------+----------+---------------+------------+--------------+-------------+---------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW io_global_by_file_by_latency (</div><div class="line">  file,</div><div class="line">  total,</div><div class="line">  total_latency,</div><div class="line">  count_read,</div><div class="line">  read_latency,</div><div class="line">  count_write,</div><div class="line">  write_latency</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> v_monitor.format_path(file_name) <span class="keyword">AS</span> file, </div><div class="line">       count_star <span class="keyword">AS</span> total, </div><div class="line">       v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency,</div><div class="line">       count_read,</div><div class="line">       v_monitor.format_time(sum_timer_read) <span class="keyword">AS</span> read_latency,</div><div class="line">       count_write,</div><div class="line">       v_monitor.format_time(sum_timer_write) <span class="keyword">AS</span> write_latency</div><div class="line">  <span class="keyword">FROM</span> performance_schema.file_summary_by_instance</div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line">/*</div><div class="line">*	IO 相关，classes相关的延迟 ， 事件相关的延迟  <span class="keyword">Event</span> IO</div><div class="line">*   View: io_global_by_wait_by_bytes</div><div class="line">* 	使用说明： 统计每个事件的IO使用率，单位bytes，counts。 Top Waits <span class="keyword">By</span> bytes</div><div class="line">*	能解决什么问题？</div><div class="line">*	<span class="number">1</span>）专注的不再只是文件一个点，包括服务器层和引擎层。</div><div class="line">*	<span class="number">2</span>）如果relaylog非常大，说明同步有问题。</div><div class="line">*	<span class="number">3</span>）如果binlog比较大，说明binlog有问题。</div><div class="line">*	<span class="number">4</span>）如果sql/FRM 比较大，Tune table_open_cache / table_definition_cache</div><div class="line">*	<span class="number">5</span>）如果sql/file_parse比较大，如果在<span class="number">5.5</span>比较高，那就升级mysql到<span class="number">5.6</span></div><div class="line">*	<span class="number">6</span>）如果query_log比较大，那就disable genery log</div><div class="line">*	<span class="number">7</span>）如果slow log比较大，那就调整slow阈值。</div><div class="line">*   <span class="number">8</span>）还有很多值得挖掘~~</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> io_global_by_wait_by_bytes limit <span class="number">10</span>;</div><div class="line">*+-------------------------+------------+---------------+------------+------------+-------------+---------------+-----------------+</div><div class="line">*| event_name              | total      | total_latency | count_read | total_read | count_write | total_written | total_requested |</div><div class="line">*+-------------------------+------------+---------------+------------+------------+-------------+---------------+-----------------+</div><div class="line">*| innodb/innodb_data_file |  <span class="number">116249025</span> | <span class="number">3.14</span>h         |    <span class="number">1179948</span> | <span class="number">25.17</span> GiB  |   <span class="number">100838192</span> | <span class="number">2.35</span> TiB      | <span class="number">2.37</span> TiB        |</div><div class="line">*| sql/relaylog            | <span class="number">4401630943</span> | <span class="number">4.67</span>h         |  <span class="number">640398925</span> | <span class="number">403.44</span> GiB |  <span class="number">3120571330</span> | <span class="number">403.44</span> GiB    | <span class="number">806.88</span> GiB      |</div><div class="line">*| innodb/innodb_log_file  |  <span class="number">117730283</span> | <span class="number">2.78</span>h         |          <span class="number">0</span> | <span class="number">0</span> bytes    |    <span class="number">58871213</span> | <span class="number">43.77</span> GiB     | <span class="number">43.77</span> GiB       |</div><div class="line">*| myisam/dfile            |    <span class="number">5077011</span> | <span class="number">5.72</span> s        |    <span class="number">3376135</span> | <span class="number">841.29</span> MiB |       <span class="number">13950</span> | <span class="number">1.61</span> GiB      | <span class="number">2.43</span> GiB        |</div><div class="line">*| sql/FRM                 |     <span class="number">565451</span> | <span class="number">14.43</span> s       |     <span class="number">231981</span> | <span class="number">44.23</span> MiB  |      <span class="number">111230</span> | <span class="number">11.97</span> MiB     | <span class="number">56.21</span> MiB       |</div><div class="line">*| sql/binlog_index        |      <span class="number">38898</span> | <span class="number">1.89</span> s        |       <span class="number">5978</span> | <span class="number">203.68</span> KiB |           <span class="number">0</span> | <span class="number">0</span> bytes       | <span class="number">203.68</span> KiB      |</div><div class="line">*| sql/file_parser         |       <span class="number">1273</span> | <span class="number">26.81</span> ms      |         <span class="number">50</span> | <span class="number">83.65</span> KiB  |          <span class="number">33</span> | <span class="number">105.21</span> KiB    | <span class="number">188.86</span> KiB      |</div><div class="line">*| myisam/kfile            |       <span class="number">4910</span> | <span class="number">65.62</span> ms      |        <span class="number">342</span> | <span class="number">70.79</span> KiB  |        <span class="number">3421</span> | <span class="number">70.17</span> KiB     | <span class="number">140.96</span> KiB      |</div><div class="line">*| sql/binlog              |         <span class="number">78</span> | <span class="number">111.03</span> ms     |          <span class="number">7</span> | <span class="number">24.23</span> KiB  |          <span class="number">56</span> | <span class="number">34.59</span> KiB     | <span class="number">58.82</span> KiB       |</div><div class="line">*| sql/slow_log            |          <span class="number">2</span> | <span class="number">10.13</span> ms      |          <span class="number">0</span> | <span class="number">0</span> bytes    |           <span class="number">2</span> | <span class="number">476</span> bytes     | <span class="number">476</span> bytes       |</div><div class="line">*+-------------------------+------------+---------------+------------+------------+-------------+---------------+-----------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)</div><div class="line">*/</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW io_global_by_wait_by_bytes (</div><div class="line">  event_name,</div><div class="line">  total,</div><div class="line">  total_latency,</div><div class="line">  count_read,</div><div class="line">  total_read,</div><div class="line">  count_write,</div><div class="line">  total_written,</div><div class="line">  total_requested</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> SUBSTRING_INDEX(event_name, <span class="comment">'/', -2) event_name,</span></div><div class="line">       count_star <span class="keyword">AS</span> total,</div><div class="line">       v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency,</div><div class="line">       count_read,</div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_read) <span class="keyword">AS</span> total_read,</div><div class="line">       count_write,</div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_write) <span class="keyword">AS</span> total_written,</div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_write + sum_number_of_bytes_read) <span class="keyword">AS</span> total_requested</div><div class="line">  <span class="keyword">FROM</span> performance_schema.file_summary_by_event_name</div><div class="line"> <span class="keyword">WHERE</span> event_name <span class="keyword">LIKE</span> <span class="comment">'wait/io/file/%' </span></div><div class="line">   <span class="keyword">AND</span> count_star &gt; <span class="number">0</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_number_of_bytes_write + sum_number_of_bytes_read DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line">/*</div><div class="line">*	IO 相关，classes相关的延迟 ， 事件相关的延迟  <span class="keyword">Event</span> IO</div><div class="line">*   View: io_global_by_wait_by_latency</div><div class="line">* 	使用说明： 统计每个事件的IO latency	</div><div class="line">*	能解决什么问题？</div><div class="line">*	<span class="number">1</span>）和io_global_by_wait_by_bytes一样，只是维度不同。  -- 延迟的维度</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> io_global_by_wait_by_latency limit <span class="number">10</span>;</div><div class="line">*+-------------------------+------------+---------------+--------------+---------------+------------+------------+-------------+---------------+</div><div class="line">*| event_name              | total      | total_latency | read_latency | write_latency | count_read | total_read | count_write | total_written |</div><div class="line">*+-------------------------+------------+---------------+--------------+---------------+------------+------------+-------------+---------------+</div><div class="line">*| sql/relaylog            | <span class="number">4402876075</span> | <span class="number">4.67</span>h         | <span class="number">00</span>:<span class="number">34</span>:<span class="number">17.72</span>  | <span class="number">3.56</span>h         |  <span class="number">640580183</span> | <span class="number">403.56</span> GiB |  <span class="number">3121453858</span> | <span class="number">403.55</span> GiB    |</div><div class="line">*| innodb/innodb_data_file |  <span class="number">116267316</span> | <span class="number">3.14</span>h         | <span class="number">00</span>:<span class="number">18</span>:<span class="number">01.37</span>  | <span class="number">00</span>:<span class="number">22</span>:<span class="number">40.06</span>   |    <span class="number">1179948</span> | <span class="number">25.17</span> GiB  |   <span class="number">100854878</span> | <span class="number">2.35</span> TiB      |</div><div class="line">*| innodb/innodb_log_file  |  <span class="number">118276625</span> | <span class="number">2.79</span>h         | <span class="number">0</span> ps         | <span class="number">00</span>:<span class="number">06</span>:<span class="number">09.20</span>   |          <span class="number">0</span> | <span class="number">0</span> bytes    |    <span class="number">59144386</span> | <span class="number">43.97</span> GiB     |</div><div class="line">*| sql/FRM                 |     <span class="number">565457</span> | <span class="number">14.43</span> s       | <span class="number">11.19</span> s      | <span class="number">186.53</span> ms     |     <span class="number">231983</span> | <span class="number">44.23</span> MiB  |      <span class="number">111230</span> | <span class="number">11.97</span> MiB     |</div><div class="line">*| myisam/dfile            |    <span class="number">5077011</span> | <span class="number">5.72</span> s        | <span class="number">2.47</span> s       | <span class="number">2.32</span> s        |    <span class="number">3376135</span> | <span class="number">841.29</span> MiB |       <span class="number">13950</span> | <span class="number">1.61</span> GiB      |</div><div class="line">*| sql/binlog_index        |      <span class="number">38898</span> | <span class="number">1.89</span> s        | <span class="number">19.19</span> ms     | <span class="number">0</span> ps          |       <span class="number">5978</span> | <span class="number">203.68</span> KiB |           <span class="number">0</span> | <span class="number">0</span> bytes       |</div><div class="line">*| sql/binlog              |         <span class="number">78</span> | <span class="number">111.03</span> ms     | <span class="number">20.85</span> us     | <span class="number">671.02</span> us     |          <span class="number">7</span> | <span class="number">24.23</span> KiB  |          <span class="number">56</span> | <span class="number">34.59</span> KiB     |</div><div class="line">*| myisam/kfile            |       <span class="number">4910</span> | <span class="number">65.62</span> ms      | <span class="number">572.33</span> us    | <span class="number">39.10</span> ms      |        <span class="number">342</span> | <span class="number">70.79</span> KiB  |        <span class="number">3421</span> | <span class="number">70.17</span> KiB     |</div><div class="line">*| archive/data            |       <span class="number">6931</span> | <span class="number">30.00</span> ms      | <span class="number">0</span> ps         | <span class="number">0</span> ps          |          <span class="number">0</span> | <span class="number">0</span> bytes    |           <span class="number">0</span> | <span class="number">0</span> bytes       |</div><div class="line">*| sql/file_parser         |       <span class="number">1274</span> | <span class="number">26.81</span> ms      | <span class="number">189.70</span> us    | <span class="number">597.35</span> us     |         <span class="number">50</span> | <span class="number">83.65</span> KiB  |          <span class="number">33</span> | <span class="number">105.21</span> KiB    |</div><div class="line">*+-------------------------+------------+---------------+--------------+---------------+------------+------------+-------------+---------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec) </div><div class="line">*/</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW io_global_by_wait_by_latency (</div><div class="line">  event_name,</div><div class="line">  total,</div><div class="line">  total_latency,</div><div class="line">  read_latency,</div><div class="line">  write_latency,</div><div class="line">  count_read,</div><div class="line">  total_read,</div><div class="line">  count_write,</div><div class="line">  total_written</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> SUBSTRING_INDEX(event_name, <span class="comment">'/', -2) AS event_name,</span></div><div class="line">       count_star <span class="keyword">AS</span> total,</div><div class="line">       v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency,</div><div class="line">       v_monitor.format_time(sum_timer_read) <span class="keyword">AS</span> read_latency,</div><div class="line">       v_monitor.format_time(sum_timer_write) <span class="keyword">AS</span> write_latency,</div><div class="line">       count_read,</div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_read) <span class="keyword">AS</span> total_read,</div><div class="line">       count_write,</div><div class="line">       v_monitor.format_bytes(sum_number_of_bytes_write) <span class="keyword">AS</span> total_written</div><div class="line">  <span class="keyword">FROM</span> performance_schema.file_summary_by_event_name </div><div class="line"> <span class="keyword">WHERE</span> event_name <span class="keyword">LIKE</span> <span class="comment">'wait/io/file/%'</span></div><div class="line">   <span class="keyword">AND</span> count_star &gt; <span class="number">0</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"> /*</div><div class="line"> *	Table IO 相关</div><div class="line"> *	View:io_global_by_table_by_latency</div><div class="line"> *	使用说明：Top Tables <span class="keyword">By</span> Latency</div><div class="line"> *  能解决什么问题：</div><div class="line"> *	<span class="number">1</span>） 从table的角度来衡量DB的压力。</div><div class="line"> *  <span class="number">2</span>） 和io_global_by_file_by_latency类似，io_global_by_file_by_latency 考虑的是文件，是物理IO。而io_global_by_table_by_latency更多的是上层的压力分布。</div><div class="line"> *	<span class="number">3</span>） 除了能解决io_global_by_file_by_latency的问题外，还可以发现并发的问题。</div><div class="line"> *		比如：如果这里table的total很低，但是total_latency 很高，这就能很好的说明，<span class="number">80</span>%是由于这个file的并发访问造成的high latency</div><div class="line"> *	<span class="number">4</span>)  它还能做一件非常niubility的事情，那就是查看哪些表已经不被使用，已经下线了。其实很多开发也会问哪些表不被使用了，这下就可以派上用场了。好处：a）优化业务 b）减少磁盘空间。 c）减少备份的压力。</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> io_global_by_table_by_latency limit <span class="number">10</span>;</div><div class="line">*+-----------------+--------------------------------+----------+---------------+-------------+-------------+</div><div class="line">*| table_schema    | table_name                     | total    | total_latency | avg_latency | max_latency |</div><div class="line">*+-----------------+--------------------------------+----------+---------------+-------------+-------------+</div><div class="line">*| anjuke_db       | ajk_propertysale               | <span class="number">17053410</span> | <span class="number">1.11</span>h         | <span class="number">233.37</span> us   | <span class="number">1.40</span> s      |</div><div class="line">*| anjuke_db       | ajk_members                    | <span class="number">65246324</span> | <span class="number">00</span>:<span class="number">33</span>:<span class="number">58.47</span>   | <span class="number">31.24</span> us    | <span class="number">323.66</span> ms   |</div><div class="line">*| anjuke_db       | ajk_brokerextend               | <span class="number">51277324</span> | <span class="number">00</span>:<span class="number">23</span>:<span class="number">31.12</span>   | <span class="number">27.52</span> us    | <span class="number">423.48</span> ms   |</div><div class="line">*| stats_db        | list_acenter_consume_c         | <span class="number">73892219</span> | <span class="number">00</span>:<span class="number">13</span>:<span class="number">44.54</span>   | <span class="number">11.16</span> us    | <span class="number">414.73</span> ms   |</div><div class="line">*| anjuke_db       | log_broker_login_201406        | <span class="number">25700871</span> | <span class="number">00</span>:<span class="number">13</span>:<span class="number">00.67</span>   | <span class="number">30.38</span> us    | <span class="number">514.11</span> ms   |</div><div class="line">*| propertys_sh_db | ajk_propertys                  | <span class="number">14348854</span> | <span class="number">00</span>:<span class="number">12</span>:<span class="number">51.18</span>   | <span class="number">53.75</span> us    | <span class="number">758.49</span> ms   |</div><div class="line">*| stats_db        | list_acenter_charge_c          | <span class="number">33333810</span> | <span class="number">00</span>:<span class="number">11</span>:<span class="number">59.95</span>   | <span class="number">21.60</span> us    | <span class="number">321.49</span> ms   |</div><div class="line">*| anjuke_db       | ajk_private_tag                |  <span class="number">9723376</span> | <span class="number">00</span>:<span class="number">10</span>:<span class="number">56.38</span>   | <span class="number">67.51</span> us    | <span class="number">428.58</span> ms   |</div><div class="line">*| anjuke_db       | account_balance_log_sublist_06 | <span class="number">24463818</span> | <span class="number">00</span>:<span class="number">10</span>:<span class="number">38.03</span>   | <span class="number">26.08</span> us    | <span class="number">427.08</span> ms   |</div><div class="line">*| anjuke_db       | ajk_property_data              | <span class="number">23114971</span> | <span class="number">00</span>:<span class="number">09</span>:<span class="number">31.39</span>   | <span class="number">24.72</span> us    | <span class="number">305.56</span> ms   |</div><div class="line">*+-----------------+--------------------------------+----------+---------------+-------------+-------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</div><div class="line"> */</div><div class="line"> </div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW io_global_by_table_by_latency (</div><div class="line">   table_schema,</div><div class="line">   table_name,</div><div class="line">   total,</div><div class="line">   total_latency,</div><div class="line">   avg_latency,</div><div class="line">   max_latency</div><div class="line"> ) <span class="keyword">AS</span> </div><div class="line"> <span class="keyword">SELECT</span> object_schema <span class="keyword">AS</span> table_schema,</div><div class="line">             object_name <span class="keyword">AS</span> table_name,</div><div class="line">             count_star <span class="keyword">AS</span> total,</div><div class="line">             v_monitor.format_time(sum_timer_wait) <span class="keyword">as</span> total_latency,</div><div class="line">             v_monitor.format_time(sum_timer_wait / count_star) <span class="keyword">as</span> avg_latency,</div><div class="line">             v_monitor.format_time(max_timer_wait) <span class="keyword">as</span> max_latency</div><div class="line">  <span class="keyword">FROM</span> performance_schema.objects_summary_global_by_type</div><div class="line">       <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait DESC;</div><div class="line"> </div><div class="line">/*</div><div class="line">*	Table IO 相关	</div><div class="line">*	View:io_global_by_table_detail_breakdown</div><div class="line">*	使用说明： Table Usage Detailed Breakdown	  </div><div class="line">*	可以解决的问题：</div><div class="line">*	<span class="number">1</span>） 可以精确到表级别的IOPS，TPS。为诊断问题性能问题提供可靠的粒度。</div><div class="line">*	<span class="number">2</span>） 可以指导通过数据来了解业务并且指导业务开发，为什么IUD很高，为什么S很高。</div><div class="line">*	<span class="number">3</span>） 有些表如果只有IDU，或者甚至只有I，那么这些表根本就不适合放入在线DB，so，可以提供在线DB的架构优化。	   </div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> io_global_by_table_detail_breakdown limit <span class="number">10</span>;</div><div class="line">*+-----------------+--------------------------------+----------+----------------+---------+----------------+----------+----------------+---------+----------------+</div><div class="line">*| table_schema    | table_name                     | selects  | select_latency | inserts | insert_latency | updates  | update_latency | deletes | delete_latency |</div><div class="line">*+-----------------+--------------------------------+----------+----------------+---------+----------------+----------+----------------+---------+----------------+</div><div class="line">*| anjuke_db       | ajk_propertysale               |  <span class="number">6532225</span> | <span class="number">00</span>:<span class="number">56</span>:<span class="number">34.78</span>    | <span class="number">1105708</span> | <span class="number">00</span>:<span class="number">03</span>:<span class="number">03.19</span>    |  <span class="number">1944954</span> | <span class="number">00</span>:<span class="number">06</span>:<span class="number">20.39</span>    | <span class="number">1322582</span> | <span class="number">17.20</span> s        |</div><div class="line">*| anjuke_db       | ajk_members                    | <span class="number">16270425</span> | <span class="number">00</span>:<span class="number">11</span>:<span class="number">49.35</span>    |   <span class="number">60983</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">36.68</span>    | <span class="number">16267120</span> | <span class="number">00</span>:<span class="number">20</span>:<span class="number">05.95</span>    |      <span class="number">59</span> | <span class="number">17.76</span> ms       |</div><div class="line">*| anjuke_db       | ajk_brokerextend               | <span class="number">15377867</span> | <span class="number">00</span>:<span class="number">11</span>:<span class="number">36.55</span>    |    <span class="number">4083</span> | <span class="number">3.56</span> s         |  <span class="number">5142498</span> | <span class="number">00</span>:<span class="number">11</span>:<span class="number">26.88</span>    |       <span class="number">0</span> | <span class="number">0</span> ps           |</div><div class="line">*| stats_db        | list_acenter_consume_c         | <span class="number">16288296</span> | <span class="number">00</span>:<span class="number">03</span>:<span class="number">28.84</span>    | <span class="number">8260912</span> | <span class="number">00</span>:<span class="number">06</span>:<span class="number">12.97</span>    |  <span class="number">8260912</span> | <span class="number">00</span>:<span class="number">02</span>:<span class="number">30.94</span>    | <span class="number">7997084</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">08.67</span>    |</div><div class="line">*| anjuke_db       | log_broker_login_201406        |        <span class="number">0</span> | <span class="number">0</span> ps           | <span class="number">8568979</span> | <span class="number">00</span>:<span class="number">12</span>:<span class="number">47.28</span>    |        <span class="number">0</span> | <span class="number">0</span> ps           |       <span class="number">0</span> | <span class="number">0</span> ps           |</div><div class="line">*| propertys_sh_db | ajk_propertys                  |  <span class="number">3963117</span> | <span class="number">00</span>:<span class="number">04</span>:<span class="number">44.38</span>    |  <span class="number">366787</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">46.98</span>    |  <span class="number">2521943</span> | <span class="number">00</span>:<span class="number">05</span>:<span class="number">33.12</span>    |  <span class="number">397469</span> | <span class="number">41.13</span> s        |</div><div class="line">*| stats_db        | list_acenter_charge_c          |  <span class="number">8292546</span> | <span class="number">00</span>:<span class="number">03</span>:<span class="number">34.09</span>    |   <span class="number">56871</span> | <span class="number">7.38</span> s         |  <span class="number">8292546</span> | <span class="number">00</span>:<span class="number">08</span>:<span class="number">06.29</span>    |       <span class="number">0</span> | <span class="number">0</span> ps           |</div><div class="line">*| anjuke_db       | ajk_private_tag                |  <span class="number">3811793</span> | <span class="number">00</span>:<span class="number">09</span>:<span class="number">27.39</span>    |  <span class="number">158063</span> | <span class="number">43.71</span> s        |  <span class="number">3811793</span> | <span class="number">44.06</span> s        |       <span class="number">0</span> | <span class="number">0</span> ps           |</div><div class="line">*| anjuke_db       | account_balance_log_sublist_06 |        <span class="number">0</span> | <span class="number">0</span> ps           | <span class="number">8156298</span> | <span class="number">00</span>:<span class="number">10</span>:<span class="number">25.48</span>    |        <span class="number">0</span> | <span class="number">0</span> ps           |       <span class="number">0</span> | <span class="number">0</span> ps           |</div><div class="line">*| anjuke_db       | ajk_property_data              |  <span class="number">5598966</span> | <span class="number">00</span>:<span class="number">04</span>:<span class="number">29.53</span>    | <span class="number">1104535</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">31.36</span>    |  <span class="number">4277478</span> | <span class="number">00</span>:<span class="number">02</span>:<span class="number">50.94</span>    | <span class="number">1321179</span> | <span class="number">31.39</span> s        |</div><div class="line">*+-----------------+--------------------------------+----------+----------------+---------+----------------+----------+----------------+---------+----------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)    </div><div class="line">	   </div><div class="line">	   </div><div class="line">*  重点说明：以performance_schema.table_io_waits_summary_by_table举例</div><div class="line">*	<span class="number">1</span>) 几个常用的命令：</div><div class="line">*	   show variables <span class="keyword">like</span> <span class="comment">'perf%';</span></div><div class="line">*	   show status <span class="keyword">like</span> <span class="comment">'perf%';</span></div><div class="line">*	   show engine performance_schema status;</div><div class="line">*	   	(table_share_hash).count --&gt; performance_schema 监控 当前表的数量</div><div class="line">*	    (table_share_hash).size  --&gt; performance_schema 监控 表打开的最大的数量</div><div class="line">*	   </div><div class="line">*	<span class="number">2</span>）如果(table_share_hash).size 达到最大限制了会有什么影响？如何解决？</div><div class="line">*	   a）如果达到最大限制，即(table_share_hash).count = (table_share_hash).size ， 之后新的表就不能被统计进来。</div><div class="line">*	   b）原来已经打开的表，任然受监控，不影响。</div><div class="line">*	   </div><div class="line">*	   如何解决呢？</div><div class="line">*	   a）如果可以停mysql的话，可以调大performance_schema_max_table_instances 值。</div><div class="line">*	   b）如果不能停mysql，可以适当的删除一些表如： drop table xx; 这样做可以减少(table_share_hash).count的数量。</div><div class="line">*	   c）注意： truncate table performance_schema.table_io_waits_summary_by_table  只能reset status = <span class="number">0</span> ，不会删除里面的记录，所以这个行不通。</div><div class="line">*	   </div><div class="line">*	<span class="number">3</span>) performance_schema.table_io_waits_summary_by_table 里面的count_fetch 需要注意：</div><div class="line">*	   a）count_fetch, 指的是数据库底层com_fetch的量，千万别理解成<span class="keyword">select</span>。</div><div class="line">*	   b）哪些操作会导致count_fetch 增长呢？</div><div class="line">*	   	   <span class="number">1</span>）insert 操作不会造成 count_fetch ++ , 但是update 会造成 count_fetch ++。 </div><div class="line">*	   	   <span class="number">2</span>）其实，这也很好理解，因为update语句，会从数据库中fetch数据到server层以及内存，然后在修改。</div><div class="line">*	       <span class="number">3</span>）<span class="keyword">select</span> 操作会造成 count_fetch 增长。</div><div class="line">*	   c）一次<span class="keyword">select</span>，count_fetch 增长 <span class="number">1</span> 么？</div><div class="line">*	   		<span class="number">1</span>）显然不是，count_fetch 指的是： 一次底层fetch调用，增长一次。</div><div class="line">*	   		<span class="number">2</span>）比如：有一张表<span class="number">100</span>条记录。</div><div class="line">*	   				SQL语句为：<span class="keyword">select</span> * <span class="keyword">from</span> table;</div><div class="line">*	   				rows_affected: <span class="number">100</span>rows</div><div class="line">*	   			那么count_fetch 至少是<span class="number">100</span>，而不是<span class="number">1.</span> </div><div class="line">*	   </div><div class="line">*	   			为什么说至少是<span class="number">100</span>呢？ </div><div class="line">*	   				a）有可能会从二级索引中fetch 数据。</div><div class="line">*	   				b）然后再从主键索引中fetch 数据。</div><div class="line">*	   				c）以上两点都是我的推断。。--待验证，解决。</div><div class="line">*	   </div><div class="line">*	   d）特别注意： 有的时候count_update 不增长，也没有<span class="keyword">select</span> 操作，为啥count_fetch 会增长呢？</div><div class="line">*	   		<span class="number">1</span>）如果理解了count_fetch,你就不难懂了。</div><div class="line">*	   		<span class="number">2</span>）fetch 指的是从数据库文件fetch的fetch 调用。举例子： table_A</div><div class="line">*	   </div><div class="line">*	   		id  name</div><div class="line">*	   		<span class="number">1</span>   <span class="comment">'lan'</span></div><div class="line">*	   		<span class="number">2</span>   <span class="comment">'chun'</span></div><div class="line">*	   		一条SQL语句如： update table_A <span class="keyword">set</span> name = <span class="comment">'test' where id = 3; 你猜，会怎样？</span></div><div class="line">*	   		结果是：</div><div class="line">*	   		count_fetch 增加，count_update 没有增加。因为：根本就没有id=<span class="number">3</span>的记录与之匹配，也就是说udpate根本就没有更改任何记录，</div><div class="line">*	   		所以count_update 不会增加，但是有fetch操作，所以count_fetch 由此增长。</div><div class="line">*	   	</div><div class="line">*	   		</div><div class="line">*/ </div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">	 ALGORITHM = MERGE</div><div class="line">	 DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">	 SQL SECURITY INVOKER </div><div class="line">VIEW io_global_by_table_detail_breakdown (</div><div class="line">	 table_schema,</div><div class="line">	 table_name,</div><div class="line">	 rows_io_total,</div><div class="line">	 rows_reads,</div><div class="line">	 rows_writes,</div><div class="line">	 rows_fetchs,</div><div class="line">	 rows_inserts,</div><div class="line">	 rows_updates,	</div><div class="line">	 rows_deletes,	  </div><div class="line">	 select_latency,	 </div><div class="line">	 insert_latency,</div><div class="line">	 update_latency,</div><div class="line">	 delete_latency</div><div class="line">	   ) <span class="keyword">AS</span> </div><div class="line"><span class="keyword">SELECT</span> object_schema <span class="keyword">AS</span> table_schema, </div><div class="line">			object_name <span class="keyword">AS</span> table_name,</div><div class="line">			count_star <span class="keyword">AS</span> rows_io_total,</div><div class="line">			count_read <span class="keyword">AS</span> rows_read,			</div><div class="line">			count_write <span class="keyword">AS</span> rows_write,</div><div class="line">	   		count_fetch <span class="keyword">AS</span> rows_fetchs, </div><div class="line">	   	 	count_insert <span class="keyword">AS</span> rows_inserts,</div><div class="line">			count_update <span class="keyword">AS</span> rows_updates,</div><div class="line">	   	 	count_delete <span class="keyword">AS</span> rows_deletes,			</div><div class="line">			v_monitor.format_time(sum_timer_fetch)  <span class="keyword">AS</span> fetch_latency,			</div><div class="line">			v_monitor.format_time(sum_timer_insert) <span class="keyword">AS</span> insert_latency, </div><div class="line">			v_monitor.format_time(sum_timer_update) <span class="keyword">AS</span> update_latency, </div><div class="line">			v_monitor.format_time(sum_timer_delete) <span class="keyword">AS</span> delete_latency	   </div><div class="line">	 <span class="keyword">FROM</span> performance_schema.table_io_waits_summary_by_table </div><div class="line">	  	<span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait DESC ;</div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line">/*</div><div class="line">*	Table 索引IO 相关	</div><div class="line">*	View:schema_index_statistics</div><div class="line">*   用于检测索引的使用情况	</div><div class="line">*   <span class="number">1</span>）哪些索引没有利用？ <span class="number">2</span>）哪些索引使用率高		</div><div class="line">*/</div><div class="line">		</div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">	ALGORITHM = MERGE</div><div class="line">	DEFINER = <span class="comment">'xxx'@'%'</span></div><div class="line">	SQL SECURITY INVOKER </div><div class="line">VIEW schema_index_statistics (</div><div class="line">		  table_schema,</div><div class="line">		  table_name,</div><div class="line">		  index_name,</div><div class="line">		  rows_fetched,</div><div class="line">		  select_latency,</div><div class="line">		  rows_inserted,</div><div class="line">		  insert_latency,</div><div class="line">		  rows_updated,</div><div class="line">		  update_latency,</div><div class="line">		  rows_deleted,</div><div class="line">		  delete_latency</div><div class="line">    ) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> OBJECT_SCHEMA <span class="keyword">AS</span> table_schema,</div><div class="line">		       OBJECT_NAME <span class="keyword">AS</span> table_name,</div><div class="line">		       INDEX_NAME <span class="keyword">as</span> index_name,</div><div class="line">		       COUNT_FETCH <span class="keyword">AS</span> rows_fetched,</div><div class="line">		       v_monitor.format_time(SUM_TIMER_FETCH) <span class="keyword">AS</span> select_latency,</div><div class="line">		       COUNT_INSERT <span class="keyword">AS</span> rows_inserted,</div><div class="line">		       v_monitor.format_time(SUM_TIMER_INSERT) <span class="keyword">AS</span> insert_latency,</div><div class="line">		       COUNT_UPDATE <span class="keyword">AS</span> rows_updated,</div><div class="line">		       v_monitor.format_time(SUM_TIMER_UPDATE) <span class="keyword">AS</span> update_latency,</div><div class="line">		       COUNT_DELETE <span class="keyword">AS</span> rows_deleted,</div><div class="line">		       v_monitor.format_time(SUM_TIMER_INSERT) <span class="keyword">AS</span> delete_latency</div><div class="line"><span class="keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage</div><div class="line"><span class="keyword">WHERE</span> index_name <span class="keyword">IS</span> <span class="keyword">NOT</span> NULL</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait DESC;		</div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line">/*</div><div class="line">*	性能调优相关： 全表扫描的schema</div><div class="line">*   View: schema_tables_with_full_table_scans</div><div class="line">* 	使用说明： 找到全表扫描的表，以扫描的行数降序排列  	</div><div class="line">*	能解决什么问题：</div><div class="line">*	<span class="number">1</span>）能找到哪些表被全表扫描的多，从而针对性的对这张表优化。</div><div class="line">*	<span class="number">2</span>）优化内存使用率。将full_scann减少，更加能够提高内存利用率。能够让更多合理的数据进入内存，从而进一步的减少了slow</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> schema_tables_with_full_table_scans limit <span class="number">10</span>;</div><div class="line">*+---------------+-----------------------------+-------------------+</div><div class="line">*| object_schema | object_name                 | rows_full_scanned |</div><div class="line">*+---------------+-----------------------------+-------------------+</div><div class="line">*| ark_db        | hp_pro_stats_hour_11        |           <span class="number">6961159</span> |</div><div class="line">*| ark_db        | hp_pro_stats_hour_oth       |           <span class="number">5957428</span> |</div><div class="line">*| ark_db        | log_rankprop_update_auction |           <span class="number">3047492</span> |</div><div class="line">*| ark_db        | hp_broker_stats_hour_oth    |            <span class="number">979462</span> |</div><div class="line">*| ark_db        | ajk_propspread              |            <span class="number">935123</span> |</div><div class="line">*| ark_db        | hp_broker_stats_hour_11     |            <span class="number">815424</span> |</div><div class="line">*| ark_db        | hp_comm_stats_hour_oth      |            <span class="number">744698</span> |</div><div class="line">*| ark_db        | hp_comm_stats_hour_11       |            <span class="number">574816</span> |</div><div class="line">*| ark_db        | hp_pro_stats_day_11         |            <span class="number">483393</span> |</div><div class="line">*| ark_db        | hp_pro_stats_day_oth        |            <span class="number">404916</span> |</div><div class="line">*+---------------+-----------------------------+-------------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</div><div class="line">*/</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW schema_tables_with_full_table_scans (</div><div class="line">  object_schema,</div><div class="line">  object_name,</div><div class="line">  rows_full_scanned</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> object_schema, </div><div class="line">       object_name,</div><div class="line">       count_read <span class="keyword">AS</span> rows_full_scanned</div><div class="line">  <span class="keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage </div><div class="line"> <span class="keyword">WHERE</span> index_name <span class="keyword">IS</span> NULL</div><div class="line">   <span class="keyword">AND</span> count_read &gt; <span class="number">0</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> count_read DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"> </div><div class="line"> /*</div><div class="line"> *	性能调优相关： 找出未使用过的index和schema</div><div class="line"> *   View: schema_unused_indexes</div><div class="line"> * 	 能解决什么问题：</div><div class="line"> *	<span class="number">1</span>）找出哪些表的使用有问题。</div><div class="line"> *	<span class="number">2</span>）找出哪些索引是从来没有被用过，进而指导DBA&&开发优化没有使用的索引，可以提高写的性能。</div><div class="line"> </div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> schema_unused_indexes limit <span class="number">10</span>;</div><div class="line">*+---------------+----------------------+--------------------+</div><div class="line">*| object_schema | object_name          | index_name         |</div><div class="line">*+---------------+----------------------+--------------------+</div><div class="line">*| ark_db        | ajk_propspread       | idx_areacode_price |</div><div class="line">*| ark_db        | ajk_propspread       | serialnumber       |</div><div class="line">*| ark_db        | ajk_propspread       | city_status_type   |</div><div class="line">*| ark_db        | ajk_propspread       | updated_datetime   |</div><div class="line">*| ark_db        | ajk_propspread       | idx_commId_price   |</div><div class="line">*| ark_db        | ajk_propspread       | broker_id          |</div><div class="line">*| ark_db        | ajk_propspread       | createtime         |</div><div class="line">*| ark_db        | ajk_propspread_queue | stoptime           |</div><div class="line">*| ark_db        | ajk_propspread_redo  | plan_id            |</div><div class="line">*| ark_db        | ajk_propspread_redo  | createtime         |</div><div class="line">*+---------------+----------------------+--------------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.05</span> sec)</div><div class="line"> */</div><div class="line"> </div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW schema_unused_indexes (</div><div class="line">   object_schema,</div><div class="line">   object_name,</div><div class="line">   index_name</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> object_schema,</div><div class="line">        object_name,</div><div class="line">        index_name</div><div class="line">   <span class="keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage </div><div class="line">  <span class="keyword">WHERE</span> index_name <span class="keyword">IS</span> <span class="keyword">NOT</span> NULL</div><div class="line">    <span class="keyword">AND</span> count_star = <span class="number">0</span></div><div class="line">    <span class="keyword">AND</span> object_schema <span class="keyword">not</span> <span class="keyword">in</span>  (<span class="comment">'mysql','v_monitor')</span></div><div class="line">	<span class="keyword">AND</span> index_name &lt;&gt; <span class="comment">'PRIMARY'</span></div><div class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> object_schema, object_name;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"> /*</div><div class="line">  *	语句statment相关</div><div class="line">  *   View: statement_analysis</div><div class="line">  * 		列出top N 个SQL的详细情况，以latency降序排列 。  兼容Mysql Enterprise Monitor</div><div class="line">  *   能解决什么问题：</div><div class="line">  *   <span class="number">1</span>）这个能解决的问题就太多了，为什么？ 因为这个就是Mysql Enterprise Monitor中的一个重要功能。</div><div class="line">  *   <span class="number">2</span>）exec</div><div class="line">  *   <span class="number">3</span>）err && warnings</div><div class="line">  *   <span class="number">4</span>）latency</div><div class="line">  *   <span class="number">5</span>）lock latency</div><div class="line">  *   <span class="number">6</span>）rows sent  && rows examed</div><div class="line">  *   <span class="number">7</span>）tmp table ** tmp disk table </div><div class="line">  *   <span class="number">8</span>）rows sort</div><div class="line">  *   <span class="number">9</span>）sort merge</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> statement_analysis \G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">*            query: INSERT <span class="keyword">INTO</span> `hp_pro_stats_hour ... PDATE `disnum` = `disnum` + ?</div><div class="line">*               db: ark_db</div><div class="line">*        full_scan:</div><div class="line">*       exec_count: <span class="number">97704732</span></div><div class="line">*        err_count: <span class="number">0</span></div><div class="line">*       warn_count: <span class="number">0</span></div><div class="line">*    total_latency: <span class="number">3.34</span>h</div><div class="line">*      max_latency: <span class="number">2.90</span> s</div><div class="line">*      avg_latency: <span class="number">123.00</span> us</div><div class="line">*     lock_latency: <span class="number">1.57</span>h</div><div class="line">*        rows_sent: <span class="number">0</span></div><div class="line">*    rows_sent_avg: <span class="number">0</span></div><div class="line">*    rows_examined: <span class="number">0</span></div><div class="line">*rows_examined_avg: <span class="number">0</span></div><div class="line">*       tmp_tables: <span class="number">0</span></div><div class="line">*  tmp_disk_tables: <span class="number">0</span></div><div class="line">*      rows_sorted: <span class="number">0</span></div><div class="line">*sort_merge_passes: <span class="number">0</span></div><div class="line">*           digest: <span class="number">4878125158</span>ccfb0239731d889bce8221</div><div class="line">*       first_seen: <span class="number">2014</span>-<span class="number">05</span>-<span class="number">20</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">36</span></div><div class="line">*        last_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">16</span>:<span class="number">31</span>:<span class="number">01</span></div><div class="line"> */</div><div class="line"></div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%'</span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW statement_analysis (</div><div class="line">   query,</div><div class="line">   db,</div><div class="line">   full_scan,</div><div class="line">   exec_count,</div><div class="line">   err_count,</div><div class="line">   warn_count,</div><div class="line">   total_latency,</div><div class="line">   max_latency,</div><div class="line">   avg_latency,</div><div class="line">   lock_latency,</div><div class="line">   rows_sent,</div><div class="line">   rows_sent_avg,</div><div class="line">   rows_examined,</div><div class="line">   rows_examined_avg,</div><div class="line">   tmp_tables,</div><div class="line">   tmp_disk_tables,</div><div class="line">   rows_sorted,</div><div class="line">   sort_merge_passes,</div><div class="line">   digest,</div><div class="line">   first_seen,</div><div class="line">   last_seen</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> v_monitor.format_statement(DIGEST_TEXT) <span class="keyword">AS</span> query,</div><div class="line">        SCHEMA_NAME <span class="keyword">AS</span> db,</div><div class="line">        <span class="keyword">IF</span>(SUM_NO_GOOD_INDEX_USED &gt; <span class="number">0</span> <span class="keyword">OR</span> SUM_NO_INDEX_USED &gt; <span class="number">0</span>, <span class="comment">'*', '') AS full_scan,</span></div><div class="line">        COUNT_STAR <span class="keyword">AS</span> exec_count,</div><div class="line">        SUM_ERRORS <span class="keyword">AS</span> err_count,</div><div class="line">        SUM_WARNINGS <span class="keyword">AS</span> warn_count,</div><div class="line">        v_monitor.format_time(SUM_TIMER_WAIT) <span class="keyword">AS</span> total_latency,</div><div class="line">        v_monitor.format_time(MAX_TIMER_WAIT) <span class="keyword">AS</span> max_latency,</div><div class="line">        v_monitor.format_time(AVG_TIMER_WAIT) <span class="keyword">AS</span> avg_latency,</div><div class="line">        v_monitor.format_time(SUM_LOCK_TIME) <span class="keyword">AS</span> lock_latency,</div><div class="line">        SUM_ROWS_SENT <span class="keyword">AS</span> rows_sent,</div><div class="line">        ROUND(IFNULL(SUM_ROWS_SENT / NULLIF(COUNT_STAR, <span class="number">0</span>), <span class="number">0</span>)) <span class="keyword">AS</span> rows_sent_avg,</div><div class="line">        SUM_ROWS_EXAMINED <span class="keyword">AS</span> rows_examined,</div><div class="line">        ROUND(IFNULL(SUM_ROWS_EXAMINED / NULLIF(COUNT_STAR, <span class="number">0</span>), <span class="number">0</span>))  <span class="keyword">AS</span> rows_examined_avg,</div><div class="line">        SUM_CREATED_TMP_TABLES <span class="keyword">AS</span> tmp_tables,</div><div class="line">        SUM_CREATED_TMP_DISK_TABLES <span class="keyword">AS</span> tmp_disk_tables,</div><div class="line">        SUM_SORT_ROWS <span class="keyword">AS</span> rows_sorted,</div><div class="line">        SUM_SORT_MERGE_PASSES <span class="keyword">AS</span> sort_merge_passes,</div><div class="line">        DIGEST <span class="keyword">AS</span> digest,</div><div class="line">        FIRST_SEEN <span class="keyword">AS</span> first_seen,</div><div class="line">        LAST_SEEN <span class="keyword">as</span> last_seen</div><div class="line">   <span class="keyword">FROM</span> performance_schema.events_statements_summary_by_digest</div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT DESC;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"> /*</div><div class="line"> *	语句statment相关</div><div class="line"> *   View: statements_with_errors_or_warnings</div><div class="line"> * 	使用说明： 统计有<span class="keyword">error</span>或者warnings的top N SQL</div><div class="line"> *  能解决的问题：</div><div class="line"> *  <span class="number">1</span>) 找出有<span class="keyword">error</span> 或者 warning 的 SQL</div><div class="line"> *  <span class="number">2</span>）有warnin的语句，迟早都会变成<span class="keyword">error</span>，而且还是隐形的<span class="keyword">error</span>。-- tom kyte oracle 资深DBA</div><div class="line"> *  <span class="number">3</span>）找出频繁warning或者<span class="keyword">error</span>的SQL，有助于预防SQL注入或者更高级别的SQL攻击。</div><div class="line"> </div><div class="line">*************************** <span class="number">5.</span> row ***************************</div><div class="line">*     query: <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> `events_waits_su ... `sum_timer_wait` DESC LIMIT ?</div><div class="line">*        db: sys</div><div class="line">*exec_count: <span class="number">3</span></div><div class="line">*    errors: <span class="number">3</span></div><div class="line">*  warnings: <span class="number">0</span></div><div class="line">*first_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">16</span> <span class="number">16</span>:<span class="number">41</span>:<span class="number">02</span></div><div class="line">* last_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">16</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">39</span></div><div class="line">*    digest: <span class="number">3e9</span>e2ddc267ff4ef679a5a49855176ea</div><div class="line"> */</div><div class="line"> </div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW statements_with_errors_or_warnings (</div><div class="line">   query,</div><div class="line">   db,</div><div class="line">   exec_count,</div><div class="line">   errors,</div><div class="line">   warnings,</div><div class="line">   first_seen,</div><div class="line">   last_seen,</div><div class="line">   digest</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> v_monitor.format_statement(DIGEST_TEXT) <span class="keyword">AS</span> query,</div><div class="line">        SCHEMA_NAME <span class="keyword">as</span> db,</div><div class="line">        COUNT_STAR <span class="keyword">AS</span> exec_count,</div><div class="line">        SUM_ERRORS <span class="keyword">AS</span> errors,</div><div class="line">        SUM_WARNINGS <span class="keyword">AS</span> warnings,</div><div class="line">        FIRST_SEEN <span class="keyword">as</span> first_seen,</div><div class="line">        LAST_SEEN <span class="keyword">as</span> last_seen,</div><div class="line">        DIGEST <span class="keyword">AS</span> digest</div><div class="line">   <span class="keyword">FROM</span> performance_schema.events_statements_summary_by_digest</div><div class="line">  <span class="keyword">WHERE</span> SCHEMA_NAME <span class="keyword">not</span> <span class="keyword">in</span> (<span class="comment">'mysql','v_monitor') and (SUM_ERRORS &gt; 0 OR SUM_WARNINGS &gt; 0)</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_ERRORS DESC, SUM_WARNINGS DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"> /*</div><div class="line"> *	语句statment相关</div><div class="line"> *   View: statements_with_full_table_scans</div><div class="line"> * 		统计哪些SQL是全表扫描，按照扫描latency排序  </div><div class="line"> *   能解决什么问题：</div><div class="line"> *   <span class="number">1</span>）前面有个view可以找出被全表扫描的表的行数，这个可以找出具体的SQL。</div><div class="line"> *   <span class="number">2</span>）同样，这种SQL会浪费内存，IO，cpu，应该立刻，马上制止 （Three star system 理论）</div><div class="line"> </div><div class="line">*************************** <span class="number">2.</span> row ***************************</div><div class="line">*                   query: <span class="keyword">SELECT</span> SQL_NO_CACHE * <span class="keyword">FROM</span> `ark_db` . `hp_pro_click_fees_oth`</div><div class="line">*                      db: NULL</div><div class="line">*              exec_count: <span class="number">5</span></div><div class="line">*           total_latency: <span class="number">00</span>:<span class="number">06</span>:<span class="number">08.67</span></div><div class="line">*     no_index_used_count: <span class="number">5</span></div><div class="line">*no_good_index_used_count: <span class="number">0</span></div><div class="line">*       no_index_used_pct: <span class="number">100</span></div><div class="line">*               rows_sent: <span class="number">36203370</span></div><div class="line">*           rows_examined: <span class="number">36203370</span></div><div class="line">*           rows_sent_avg: <span class="number">7240674</span></div><div class="line">*       rows_examined_avg: <span class="number">7240674</span></div><div class="line">*              first_seen: <span class="number">2014</span>-<span class="number">05</span>-<span class="number">23</span> <span class="number">13</span>:<span class="number">02</span>:<span class="number">58</span></div><div class="line">*               last_seen: <span class="number">2014</span>-<span class="number">05</span>-<span class="number">23</span> <span class="number">14</span>:<span class="number">35</span>:<span class="number">18</span></div><div class="line">*                  digest: <span class="number">8042</span>a32250334bff7b5f17eff13ac205</div><div class="line"> </div><div class="line"> */</div><div class="line"> </div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW statements_with_full_table_scans (</div><div class="line">   query,</div><div class="line">   db,</div><div class="line">   exec_count,</div><div class="line">   total_latency,</div><div class="line">   no_index_used_count,</div><div class="line">   no_good_index_used_count,</div><div class="line">   no_index_used_pct,</div><div class="line">   rows_sent,</div><div class="line">   rows_examined,</div><div class="line">   rows_sent_avg,</div><div class="line">   rows_examined_avg,</div><div class="line">   first_seen,</div><div class="line">   last_seen,</div><div class="line">   digest</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> v_monitor.format_statement(DIGEST_TEXT) <span class="keyword">AS</span> query,</div><div class="line">        SCHEMA_NAME <span class="keyword">as</span> db,</div><div class="line">        COUNT_STAR <span class="keyword">AS</span> exec_count,</div><div class="line">        v_monitor.format_time(SUM_TIMER_WAIT) <span class="keyword">AS</span> total_latency,</div><div class="line">        SUM_NO_INDEX_USED <span class="keyword">AS</span> no_index_used_count,</div><div class="line">        SUM_NO_GOOD_INDEX_USED <span class="keyword">AS</span> no_good_index_used_count,</div><div class="line">        ROUND(IFNULL(SUM_NO_INDEX_USED / NULLIF(COUNT_STAR, <span class="number">0</span>), <span class="number">0</span>) * <span class="number">100</span>) <span class="keyword">AS</span> no_index_used_pct,</div><div class="line">        SUM_ROWS_SENT <span class="keyword">AS</span> rows_sent,</div><div class="line">        SUM_ROWS_EXAMINED <span class="keyword">AS</span> rows_examined,</div><div class="line">        ROUND(SUM_ROWS_SENT/COUNT_STAR) <span class="keyword">AS</span> rows_sent_avg,</div><div class="line">        ROUND(SUM_ROWS_EXAMINED/COUNT_STAR) <span class="keyword">AS</span> rows_examined_avg,</div><div class="line">        FIRST_SEEN <span class="keyword">as</span> first_seen,</div><div class="line">        LAST_SEEN <span class="keyword">as</span> last_seen,</div><div class="line">        DIGEST <span class="keyword">AS</span> digest</div><div class="line">   <span class="keyword">FROM</span> performance_schema.events_statements_summary_by_digest</div><div class="line">  <span class="keyword">WHERE</span> SCHEMA_NAME <span class="keyword">not</span> <span class="keyword">in</span> (<span class="comment">'mysql','v_monitor') and (SUM_NO_INDEX_USED &gt; 0 OR SUM_NO_GOOD_INDEX_USED &gt; 0)</span></div><div class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> no_index_used_pct DESC, SUM_TIMER_WAIT DESC;</div><div class="line">  </div><div class="line">  </div><div class="line"> </div><div class="line"> /*</div><div class="line"> *	语句statment相关</div><div class="line"> *   View: statements_with_sorting</div><div class="line"> *		统计需要排序的top N SQL</div><div class="line"> *	 能解决什么问题：</div><div class="line"> *	 <span class="number">1</span>） 找出排序延迟对多的SQL</div><div class="line"> *	 <span class="number">2</span>） 这种SQL，会非常好内存和cpu ，应该避免。 （Three star system 理论）</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">*            query: <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> `innodb_buffer_s ... _SIZE` = ? ) , ? , `ibp` . ...</div><div class="line">*               db: ark_db</div><div class="line">*       exec_count: <span class="number">1</span></div><div class="line">*    total_latency: <span class="number">00</span>:<span class="number">04</span>:<span class="number">58.40</span></div><div class="line">*sort_merge_passes: <span class="number">0</span></div><div class="line">*sorts_using_scans: <span class="number">2</span></div><div class="line">* sort_using_range: <span class="number">0</span></div><div class="line">*      rows_sorted: <span class="number">1685768</span></div><div class="line">*       first_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">03</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">20</span></div><div class="line">*        last_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">03</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">20</span></div><div class="line">*           digest: <span class="number">8819</span>ae6337417a82fa5ada32dd5b8de2</div><div class="line"> */</div><div class="line"> </div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW statements_with_sorting (</div><div class="line">   query,</div><div class="line">   db,</div><div class="line">   exec_count,</div><div class="line">   total_latency,</div><div class="line">   sort_merge_passes,</div><div class="line">   sorts_using_scans,</div><div class="line">   sort_using_range,</div><div class="line">   rows_sorted,</div><div class="line">   first_seen,</div><div class="line">   last_seen,</div><div class="line">   digest</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> v_monitor.format_statement(DIGEST_TEXT) <span class="keyword">AS</span> query,</div><div class="line">        SCHEMA_NAME db,</div><div class="line">        COUNT_STAR <span class="keyword">AS</span> exec_count,</div><div class="line">        v_monitor.format_time(SUM_TIMER_WAIT) <span class="keyword">AS</span> total_latency,</div><div class="line">        SUM_SORT_MERGE_PASSES <span class="keyword">AS</span> sort_merge_passes,</div><div class="line">        SUM_SORT_SCAN <span class="keyword">AS</span> sorts_using_scans,</div><div class="line">        SUM_SORT_RANGE <span class="keyword">AS</span> sort_using_range,</div><div class="line">        SUM_SORT_ROWS <span class="keyword">AS</span> rows_sorted,</div><div class="line">        FIRST_SEEN <span class="keyword">as</span> first_seen,</div><div class="line">        LAST_SEEN <span class="keyword">as</span> last_seen,</div><div class="line">        DIGEST <span class="keyword">AS</span> digest</div><div class="line">   <span class="keyword">FROM</span> performance_schema.events_statements_summary_by_digest</div><div class="line">  <span class="keyword">WHERE</span> SUM_SORT_ROWS &gt; <span class="number">0</span> <span class="keyword">and</span> SCHEMA_NAME <span class="keyword">not</span> <span class="keyword">in</span> (<span class="comment">'mysql','v_monitor')</span></div><div class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT DESC;</div><div class="line"> </div><div class="line"> /*</div><div class="line"> *	语句statment相关</div><div class="line"> *   View: statements_with_temp_tables</div><div class="line"> * 		统计需要临时表（磁盘，内存）TOP N  SQL</div><div class="line"> *   能解决什么问题：</div><div class="line"> *	 <span class="number">1</span>） 找出使用临时表最多的SQL</div><div class="line"> *   <span class="number">2</span>） 临时表，我想不用多少，可以让性能跌倒谷底（特别是disk 临时表） ，应该避免 （Three star system 理论）</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line">*                   query: <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> `schema_object_o ... MA` , `information_schema` ...</div><div class="line">*                      db: sys</div><div class="line">*              exec_count: <span class="number">3</span></div><div class="line">*           total_latency: <span class="number">8.91</span> s</div><div class="line">*       memory_tmp_tables: <span class="number">567</span></div><div class="line">*         disk_tmp_tables: <span class="number">99</span></div><div class="line">*avg_tmp_tables_per_query: <span class="number">189</span></div><div class="line">*  tmp_tables_to_disk_pct: <span class="number">17</span></div><div class="line">*              first_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">03</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">44</span></div><div class="line">*               last_seen: <span class="number">2014</span>-<span class="number">06</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">42</span>:<span class="number">36</span></div><div class="line">*                  digest: ccc857fb69a9f151a1b8cb8687697b1a</div><div class="line"> */</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW statements_with_temp_tables (</div><div class="line">  query,</div><div class="line">  db,</div><div class="line">  exec_count,</div><div class="line">  total_latency,</div><div class="line">  memory_tmp_tables,</div><div class="line">  disk_tmp_tables,</div><div class="line">  avg_tmp_tables_per_query,</div><div class="line">  tmp_tables_to_disk_pct,</div><div class="line">  first_seen,</div><div class="line">  last_seen,</div><div class="line">  digest</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> v_monitor.format_statement(DIGEST_TEXT) <span class="keyword">AS</span> query,</div><div class="line">       SCHEMA_NAME <span class="keyword">as</span> db,</div><div class="line">       COUNT_STAR <span class="keyword">AS</span> exec_count,</div><div class="line">       v_monitor.format_time(SUM_TIMER_WAIT) <span class="keyword">as</span> total_latency,</div><div class="line">       SUM_CREATED_TMP_TABLES <span class="keyword">AS</span> memory_tmp_tables,</div><div class="line">       SUM_CREATED_TMP_DISK_TABLES <span class="keyword">AS</span> disk_tmp_tables,</div><div class="line">       ROUND(IFNULL(SUM_CREATED_TMP_TABLES / NULLIF(COUNT_STAR, <span class="number">0</span>), <span class="number">0</span>)) <span class="keyword">AS</span> avg_tmp_tables_per_query,</div><div class="line">       ROUND(IFNULL(SUM_CREATED_TMP_DISK_TABLES / NULLIF(SUM_CREATED_TMP_TABLES, <span class="number">0</span>), <span class="number">0</span>) * <span class="number">100</span>) <span class="keyword">AS</span> tmp_tables_to_disk_pct,</div><div class="line">       FIRST_SEEN <span class="keyword">as</span> first_seen,</div><div class="line">       LAST_SEEN <span class="keyword">as</span> last_seen,</div><div class="line">       DIGEST <span class="keyword">AS</span> digest</div><div class="line">  <span class="keyword">FROM</span> performance_schema.events_statements_summary_by_digest</div><div class="line"> <span class="keyword">WHERE</span> SUM_CREATED_TMP_TABLES &gt; <span class="number">0</span> <span class="keyword">and</span> SCHEMA_NAME <span class="keyword">not</span> <span class="keyword">in</span> (<span class="comment">'mysql','v_monitor')</span></div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_CREATED_TMP_DISK_TABLES DESC, SUM_CREATED_TMP_TABLES DESC;</div><div class="line"></div><div class="line"></div><div class="line"> /*</div><div class="line"> *	 host相关的统计</div><div class="line"> *   View: host_summary_by_statement_type</div><div class="line"> *   统计每个statment<span class="comment">'type 的latency，count，by each host</span></div><div class="line"> *   能解决什么问题：</div><div class="line"> *	 <span class="number">1</span>）首先，这个是按照host来分类的。我们的需求，很多都是针对业务IP来的，比如：二手房，API，DFS，JOB。</div><div class="line"> *	 <span class="number">2</span>）可以清楚的知道来自那个IP，哪类业务的statment的情况，从而可以很轻松的从业务角度来衡量使用好坏。我想，这应该是代价最低，最精确的做法。</div><div class="line"> </div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> host_summary_by_statement_type limit <span class="number">10</span>;</div><div class="line">*+------------+-------------------+-------+---------------+-------------+--------------+------------+---------------+---------------+------------+</div><div class="line">*| host       | statement         | total | total_latency | max_latency | lock_latency | rows_sent  | rows_examined | rows_affected | full_scans |</div><div class="line">*+------------+-------------------+-------+---------------+-------------+--------------+------------+---------------+---------------+------------+</div><div class="line">*| localhost | <span class="keyword">select</span>            |  <span class="number">7890</span> | <span class="number">00</span>:<span class="number">59</span>:<span class="number">57.61</span>   | <span class="number">00</span>:<span class="number">02</span>:<span class="number">41.89</span> | <span class="number">4.97</span> s       | <span class="number">1215285385</span> |    <span class="number">1215285385</span> |             <span class="number">0</span> |       <span class="number">7820</span> |</div><div class="line">*| localhost | show_table_status |    <span class="number">34</span> | <span class="number">7.33</span> s        | <span class="number">3.46</span> s      | <span class="number">4.18</span> ms      |      <span class="number">14191</span> |         <span class="number">14191</span> |             <span class="number">0</span> |         <span class="number">34</span> |</div><div class="line">*| localhost | show_create_table |  <span class="number">7890</span> | <span class="number">3.98</span> s        | <span class="number">14.00</span> ms    | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| localhost | flush             |    <span class="number">13</span> | <span class="number">103.95</span> ms     | <span class="number">17.02</span> ms    | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| localhost | Binlog Dump       |     <span class="number">9</span> | <span class="number">70.03</span> ms      | <span class="number">25.89</span> ms    | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| localhost | set_option        |   <span class="number">351</span> | <span class="number">16.92</span> ms      | <span class="number">267.39</span> us   | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| localhost | show_binlogs      |     <span class="number">1</span> | <span class="number">15.62</span> ms      | <span class="number">15.62</span> ms    | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| localhost | show_databases    |     <span class="number">7</span> | <span class="number">8.25</span> ms       | <span class="number">3.95</span> ms     | <span class="number">788.00</span> us    |         <span class="number">42</span> |            <span class="number">42</span> |             <span class="number">0</span> |          <span class="number">7</span> |</div><div class="line">*| localhost | begin             |    <span class="number">91</span> | <span class="number">7.25</span> ms       | <span class="number">682.23</span> us   | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| localhost | Quit              |    <span class="number">92</span> | <span class="number">2.46</span> ms       | <span class="number">113.67</span> us   | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*+------------+-------------------+-------+---------------+-------------+--------------+------------+---------------+---------------+------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</div><div class="line"> */</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW host_summary_by_statement_type (</div><div class="line">  host,</div><div class="line">  statement,</div><div class="line">  total,</div><div class="line">  total_latency,</div><div class="line">  max_latency,</div><div class="line">  lock_latency,</div><div class="line">  rows_sent,</div><div class="line">  rows_examined,</div><div class="line">  rows_affected,</div><div class="line">  full_scans</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> host,</div><div class="line">       SUBSTRING_INDEX(event_name, <span class="comment">'/', -1) AS statement,</span></div><div class="line">       count_star <span class="keyword">AS</span> total,</div><div class="line">       v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency,</div><div class="line">       v_monitor.format_time(max_timer_wait) <span class="keyword">AS</span> max_latency,</div><div class="line">       v_monitor.format_time(sum_lock_time) <span class="keyword">AS</span> lock_latency,</div><div class="line">       sum_rows_sent <span class="keyword">AS</span> rows_sent,</div><div class="line">       sum_rows_examined <span class="keyword">AS</span> rows_examined,</div><div class="line">       sum_rows_affected <span class="keyword">AS</span> rows_affected,</div><div class="line">       sum_no_index_used + sum_no_good_index_used <span class="keyword">AS</span> full_scans</div><div class="line">  <span class="keyword">FROM</span> performance_schema.events_statements_summary_by_host_by_event_name</div><div class="line"> <span class="keyword">WHERE</span> host <span class="keyword">IS</span> <span class="keyword">NOT</span> NULL</div><div class="line">   <span class="keyword">AND</span> sum_timer_wait != <span class="number">0</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> host, sum_timer_wait DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"></div><div class="line"> /*</div><div class="line"> *	 <span class="keyword">global</span> 相关的statment级别的统计，包括延迟，exec count，rows scann</div><div class="line"> *   View: global_summary_by_statement_type</div><div class="line"> *   统计每个statment<span class="comment">'type 的latency，count，by total</span></div><div class="line"> *   可以解决什么问题：</div><div class="line"> *   <span class="number">1</span>) 上面说了按照业务分，那么很明显这个就是总体的一个情况。</div><div class="line"> *   <span class="number">2</span>） 可以分清楚的知道这台机器IOPS，TPS，甚至可以知道每年，每月这台DB的DDL变更的数量。</div><div class="line"> *   <span class="number">3</span>） 最主要的还是延迟，如果show_status ， show variables 的延迟很大，那么就要想办法优化。 为什么show status那么多，延迟那么高？</div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> global_summary_by_statement_type limit <span class="number">10</span>;</div><div class="line">*+----------------+-----------+---------------+-------------+--------------+------------+---------------+---------------+------------+</div><div class="line">*| statement      | total     | total_latency | max_latency | lock_latency | rows_sent  | rows_examined | rows_affected | full_scans |</div><div class="line">*+----------------+-----------+---------------+-------------+--------------+------------+---------------+---------------+------------+</div><div class="line">*| insert         | <span class="number">891988701</span> | <span class="number">36.21</span>h        | <span class="number">6.30</span> s      | <span class="number">15.59</span>h       |          <span class="number">0</span> |             <span class="number">0</span> |    <span class="number">2008411261</span> |          <span class="number">0</span> |</div><div class="line">*| update         |  <span class="number">79182572</span> | <span class="number">3.35</span>h         | <span class="number">2.62</span> s      | <span class="number">1.25</span>h        |          <span class="number">0</span> |      <span class="number">80241508</span> |      <span class="number">79084166</span> |          <span class="number">0</span> |</div><div class="line">*| begin          | <span class="number">971583219</span> | <span class="number">2.50</span>h         | <span class="number">37.90</span> ms    | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| <span class="keyword">select</span>         |    <span class="number">177367</span> | <span class="number">1.40</span>h         | <span class="number">00</span>:<span class="number">05</span>:<span class="number">28.72</span> | <span class="number">22.07</span> s      | <span class="number">1215746513</span> |    <span class="number">1262891559</span> |             <span class="number">0</span> |      <span class="number">50531</span> |</div><div class="line">*| delete         |    <span class="number">320751</span> | <span class="number">00</span>:<span class="number">09</span>:<span class="number">52.35</span>   | <span class="number">442.94</span> ms   | <span class="number">28.86</span> s      |          <span class="number">0</span> |      <span class="number">18367238</span> |      <span class="number">18365896</span> |          <span class="number">0</span> |</div><div class="line">*| show_status    |    <span class="number">463635</span> | <span class="number">00</span>:<span class="number">09</span>:<span class="number">29.23</span>   | <span class="number">36.06</span> ms    | <span class="number">48.18</span> s      |  <span class="number">158098899</span> |     <span class="number">158098899</span> |             <span class="number">0</span> |     <span class="number">463635</span> |</div><div class="line">*| truncate       |        <span class="number">82</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">24.88</span>   | <span class="number">15.45</span> s     | <span class="number">4.17</span> s       |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*| drop_db        |         <span class="number">2</span> | <span class="number">00</span>:<span class="number">01</span>:<span class="number">12.38</span>   | <span class="number">45.16</span> s     | <span class="number">00</span>:<span class="number">01</span>:<span class="number">12.36</span>  |          <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">3100</span> |          <span class="number">0</span> |</div><div class="line">*| show_variables |     <span class="number">84340</span> | <span class="number">56.17</span> s       | <span class="number">43.63</span> ms    | <span class="number">7.35</span> s       |      <span class="number">94226</span> |         <span class="number">94226</span> |             <span class="number">0</span> |      <span class="number">84340</span> |</div><div class="line">*| create_table   |      <span class="number">3787</span> | <span class="number">26.76</span> s       | <span class="number">108.38</span> ms   | <span class="number">0</span> ps         |          <span class="number">0</span> |             <span class="number">0</span> |             <span class="number">0</span> |          <span class="number">0</span> |</div><div class="line">*+----------------+-----------+---------------+-------------+--------------+------------+---------------+---------------+------------+</div><div class="line">*<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"> */</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW global_summary_by_statement_type (</div><div class="line">  statement,</div><div class="line">  total,</div><div class="line">  total_latency,</div><div class="line">  max_latency,</div><div class="line">  lock_latency,</div><div class="line">  rows_sent,</div><div class="line">  rows_examined,</div><div class="line">  rows_affected,</div><div class="line">  full_scans</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> </div><div class="line">       SUBSTRING_INDEX(event_name, <span class="comment">'/', -1) AS statement,</span></div><div class="line">       count_star <span class="keyword">AS</span> total,</div><div class="line">       v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency,</div><div class="line">       v_monitor.format_time(max_timer_wait) <span class="keyword">AS</span> max_latency,</div><div class="line">       v_monitor.format_time(sum_lock_time) <span class="keyword">AS</span> lock_latency,</div><div class="line">       sum_rows_sent <span class="keyword">AS</span> rows_sent,</div><div class="line">       sum_rows_examined <span class="keyword">AS</span> rows_examined,</div><div class="line">       sum_rows_affected <span class="keyword">AS</span> rows_affected,</div><div class="line">       sum_no_index_used + sum_no_good_index_used <span class="keyword">AS</span> full_scans</div><div class="line">  <span class="keyword">FROM</span> performance_schema.events_statements_summary_global_by_event_name</div><div class="line"> <span class="keyword">WHERE</span> </div><div class="line">    sum_timer_wait != <span class="number">0</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span>  sum_timer_wait DESC;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"> /*</div><div class="line"> *	 等待相关的监控 classes</div><div class="line"> *   View: wait_classes_global_by_latency</div><div class="line"> *    列出Top N 个 <span class="keyword">class</span>等待<span class="keyword">event</span>  <span class="keyword">by</span> latency  </div><div class="line"> *   能解决什么问题：</div><div class="line"> *	<span class="number">1</span>） 站在更高的角度来衡量，主要是table的io，文件的io，表的lock的wait事件延迟。</div><div class="line"> </div><div class="line">*xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> wait_classes_global_by_latency limit <span class="number">10</span>;</div><div class="line">*+-----------------+------------+---------------+-------------+-------------+-------------+</div><div class="line">*| event_class     | total      | total_latency | min_latency | avg_latency | max_latency |</div><div class="line">*+-----------------+------------+---------------+-------------+-------------+-------------+</div><div class="line">*| wait/io/table   | <span class="number">2217307512</span> | <span class="number">11.45</span>h        | <span class="number">72.29</span> ns    | <span class="number">18.59</span> us    | <span class="number">2.91</span> s      |</div><div class="line">*| wait/io/file    | <span class="number">4670586905</span> | <span class="number">10.94</span>h        | <span class="number">0</span> ps        | <span class="number">8.43</span> us     | <span class="number">746.08</span> ms   |</div><div class="line">*| wait/lock/table | <span class="number">1402423408</span> | <span class="number">00</span>:<span class="number">14</span>:<span class="number">28.26</span>   | <span class="number">117.97</span> ns   | <span class="number">619.11</span> ns   | <span class="number">12.23</span> ms    |</div><div class="line">*+-----------------+------------+---------------+-------------+-------------+-------------+</div><div class="line">*<span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</div><div class="line"> */</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = TEMPTABLE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW wait_classes_global_by_latency (</div><div class="line">  event_class,</div><div class="line">  total,</div><div class="line">  total_latency,</div><div class="line">  min_latency,</div><div class="line">  avg_latency,</div><div class="line">  max_latency</div><div class="line">) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> SUBSTRING_INDEX(event_name,<span class="comment">'/', 3) AS event_class, </span></div><div class="line">       SUM(COUNT_STAR) <span class="keyword">AS</span> total,</div><div class="line">       v_monitor.format_time(SUM(sum_timer_wait)) <span class="keyword">AS</span> total_latency,</div><div class="line">       v_monitor.format_time(MIN(min_timer_wait)) min_latency,</div><div class="line">       v_monitor.format_time(IFNULL(SUM(sum_timer_wait) / NULLIF(SUM(COUNT_STAR), <span class="number">0</span>), <span class="number">0</span>)) <span class="keyword">AS</span> avg_latency,</div><div class="line">       v_monitor.format_time(MAX(max_timer_wait)) <span class="keyword">AS</span> max_latency</div><div class="line">  <span class="keyword">FROM</span> performance_schema.events_waits_summary_global_by_event_name</div><div class="line"> <span class="keyword">WHERE</span> sum_timer_wait &gt; <span class="number">0</span></div><div class="line">   <span class="keyword">AND</span> event_name != <span class="comment">'idle'</span></div><div class="line"> <span class="keyword">GROUP</span> <span class="keyword">BY</span> SUBSTRING_INDEX(event_name,<span class="comment">'/', 3) </span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM(sum_timer_wait) DESC;</div><div class="line"></div><div class="line"></div><div class="line"> /*</div><div class="line"> *	 等待相关的监控 <span class="keyword">each</span> host</div><div class="line"> *   View: waits_by_host_by_latency</div><div class="line"> *    列出Top N 个 <span class="keyword">class</span>等待<span class="keyword">event</span>  <span class="keyword">by</span> latency  <span class="keyword">by</span> <span class="keyword">each</span> host</div><div class="line"> *   能解决什么问题：</div><div class="line"> *	 <span class="number">1</span>） 按照业务ip进行统计，统计每个ip对应的<span class="keyword">event</span>使用情况和压力情况</div><div class="line"> *	 <span class="number">2</span>)  如果wait/synch/mutex/innodb/buf_pool_mutex 比较高，那么需要增加innodb_buffer_pool_instances</div><div class="line"> *	 <span class="number">3</span>） 如果wait/synch/mutex/sql/Query_cache::structure_guard_mutex 比较高，那么需要disable query cache</div><div class="line"> *	 <span class="number">4</span>） 如果wait/synch/mutex/myisam/MYISAM_SHARE::intern_lock 比较高，那么请使用Myisam</div><div class="line"> *	 <span class="number">5</span>） 如果wait/io/file/sql/FRM 比较高，调整table_open_cache / table_definition_cache</div><div class="line"> *	 <span class="number">6</span>） 如果wait/io/file/sql/query_log <span class="keyword">and</span> wait/io/file/sql/slow_log ，调整相应的general log和slow log   </div><div class="line"> *	 <span class="number">7</span>） 如果 xxx ， 那就 YYY ， 等等。  对DB底层的知识越了解，那么可以监控的点就更多，这里应有竟有。</div><div class="line"> </div><div class="line">* xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> waits_by_host_by_latency limit <span class="number">10</span>;</div><div class="line">* +------------+--------------------------------------+------------+---------------+</div><div class="line">* | host       | <span class="keyword">event</span>                                | total      | total_latency |</div><div class="line">* +------------+--------------------------------------+------------+---------------+</div><div class="line">* | localhost | wait/io/table/sql/handler            | <span class="number">1215188725</span> | <span class="number">00</span>:<span class="number">30</span>:<span class="number">23.81</span>   |</div><div class="line">* | localhost | wait/io/file/innodb/innodb_data_file |     <span class="number">761405</span> | <span class="number">00</span>:<span class="number">11</span>:<span class="number">22.06</span>   |</div><div class="line">* | localhost | wait/io/file/sql/FRM                 |     <span class="number">385645</span> | <span class="number">2.42</span> s        |</div><div class="line">* | localhost | wait/io/file/csv/metadata            |        <span class="number">132</span> | <span class="number">633.20</span> ms     |</div><div class="line">* | localhost | wait/io/file/sql/query_log           |      <span class="number">16567</span> | <span class="number">199.15</span> ms     |</div><div class="line">* | localhost | wait/io/file/myisam/kfile            |        <span class="number">906</span> | <span class="number">67.62</span> ms      |</div><div class="line">* | localhost | wait/io/file/sql/slow_log            |        <span class="number">215</span> | <span class="number">62.09</span> ms      |</div><div class="line">* | localhost | wait/io/file/myisam/dfile            |        <span class="number">725</span> | <span class="number">41.31</span> ms      |</div><div class="line">* | localhost | wait/io/file/sql/binlog              |         <span class="number">57</span> | <span class="number">36.96</span> ms      |</div><div class="line">* | localhost | wait/lock/table/sql/handler          |      <span class="number">15520</span> | <span class="number">6.93</span> ms       |</div><div class="line">* +------------+--------------------------------------+------------+---------------+</div><div class="line">* <span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</div><div class="line"> */</div><div class="line"></div><div class="line">CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">  ALGORITHM = MERGE</div><div class="line">  DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">  SQL SECURITY INVOKER </div><div class="line">VIEW waits_by_host_by_latency (</div><div class="line">  host,</div><div class="line">  <span class="keyword">event</span>,</div><div class="line">  total,</div><div class="line">  total_latency</div><div class="line">  ) <span class="keyword">AS</span></div><div class="line"><span class="keyword">SELECT</span> host,</div><div class="line">       event_name <span class="keyword">AS</span> <span class="keyword">event</span>,</div><div class="line">       count_star <span class="keyword">AS</span> total,</div><div class="line">       v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency</div><div class="line">  <span class="keyword">FROM</span> performance_schema.events_waits_summary_by_host_by_event_name</div><div class="line"> <span class="keyword">WHERE</span> event_name != <span class="comment">'idle'</span></div><div class="line">   <span class="keyword">AND</span> host <span class="keyword">IS</span> <span class="keyword">NOT</span> NULL</div><div class="line">   <span class="keyword">AND</span> sum_timer_wait &gt; <span class="number">0</span></div><div class="line"> <span class="keyword">ORDER</span> <span class="keyword">BY</span> host, sum_timer_wait DESC;</div><div class="line"> </div><div class="line"> </div><div class="line"> /*</div><div class="line"> *	 等待相关的监控 <span class="keyword">global</span></div><div class="line"> *   View: waits_global_by_latency</div><div class="line"> *    列出top n IO相关等待<span class="keyword">event</span> <span class="keyword">by</span> latency</div><div class="line"> *	能解决什么问题：  请参考waits_by_host_by_latency</div><div class="line"> *xxx:v_monitor&gt; <span class="keyword">select</span> * <span class="keyword">from</span> waits_global_by_latency limit <span class="number">10</span>;</div><div class="line"> *+--------------------------------------+------------+---------------+-------------+-------------+</div><div class="line"> *| events                               | total      | total_latency | avg_latency | max_latency |</div><div class="line"> *+--------------------------------------+------------+---------------+-------------+-------------+</div><div class="line"> *| wait/io/table/sql/handler            | <span class="number">2217608663</span> | <span class="number">11.45</span>h        | <span class="number">18.59</span> us    | <span class="number">2.91</span> s      |</div><div class="line"> *| wait/io/file/sql/relaylog            | <span class="number">4419075002</span> | <span class="number">4.69</span>h         | <span class="number">3.82</span> us     | <span class="number">554.50</span> ms   |</div><div class="line"> *| wait/io/file/innodb/innodb_data_file |  <span class="number">121477770</span> | <span class="number">3.30</span>h         | <span class="number">97.70</span> us    | <span class="number">746.08</span> ms   |</div><div class="line"> *| wait/io/file/innodb/innodb_log_file  |  <span class="number">125421910</span> | <span class="number">2.96</span>h         | <span class="number">84.99</span> us    | <span class="number">427.05</span> ms   |</div><div class="line"> *| wait/lock/table/sql/handler          | <span class="number">1402672902</span> | <span class="number">00</span>:<span class="number">14</span>:<span class="number">28.41</span>   | <span class="number">618.97</span> ns   | <span class="number">12.23</span> ms    |</div><div class="line"> *| wait/io/file/sql/FRM                 |     <span class="number">565536</span> | <span class="number">14.44</span> s       | <span class="number">25.54</span> us    | <span class="number">427.89</span> ms   |</div><div class="line"> *| wait/io/file/myisam/dfile            |    <span class="number">5077014</span> | <span class="number">5.72</span> s        | <span class="number">1.13</span> us     | <span class="number">195.42</span> ms   |</div><div class="line"> *| wait/io/file/sql/binlog_index        |      <span class="number">38950</span> | <span class="number">1.89</span> s        | <span class="number">48.49</span> us    | <span class="number">288.94</span> ms   |</div><div class="line"> *| wait/io/file/sql/binlog              |         <span class="number">78</span> | <span class="number">111.03</span> ms     | <span class="number">1.42</span> ms     | <span class="number">110.20</span> ms   |</div><div class="line"> *| wait/io/file/myisam/kfile            |       <span class="number">4910</span> | <span class="number">65.62</span> ms      | <span class="number">13.36</span> us    | <span class="number">11.39</span> ms    |</div><div class="line"> *+--------------------------------------+------------+---------------+-------------+-------------+</div><div class="line"> *<span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.09</span> sec)</div><div class="line"> */</div><div class="line"> </div><div class="line"> CREATE <span class="keyword">OR</span> REPLACE</div><div class="line">   ALGORITHM = MERGE</div><div class="line">   DEFINER = <span class="comment">'xxx'@'%' </span></div><div class="line">   SQL SECURITY INVOKER </div><div class="line"> VIEW waits_global_by_latency (</div><div class="line">   events,</div><div class="line">   total,</div><div class="line">   total_latency,</div><div class="line">   avg_latency,</div><div class="line">   max_latency</div><div class="line"> ) <span class="keyword">AS</span></div><div class="line"> <span class="keyword">SELECT</span> event_name <span class="keyword">AS</span> <span class="keyword">event</span>,</div><div class="line">        count_star <span class="keyword">AS</span> total,</div><div class="line">        v_monitor.format_time(sum_timer_wait) <span class="keyword">AS</span> total_latency,</div><div class="line">        v_monitor.format_time(avg_timer_wait) <span class="keyword">AS</span> avg_latency,</div><div class="line">        v_monitor.format_time(max_timer_wait) <span class="keyword">AS</span> max_latency</div><div class="line">   <span class="keyword">FROM</span> performance_schema.events_waits_summary_global_by_event_name</div><div class="line">  <span class="keyword">WHERE</span> event_name != <span class="comment">'idle'</span></div><div class="line">    <span class="keyword">AND</span> sum_timer_wait &gt; <span class="number">0</span></div><div class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait DESC;</div></pre></td></tr></table></figure>

<h2 id="参考资料">参考资料</h2>
<hr>
<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.6/en/performance-schema.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.6/en/performance-schema.html</a></li>
<li><a href="http://www.markleith.co.uk/2011/04/18/monitoring-table-and-index-io-with-performance_schema/" target="_blank" rel="external">http://www.markleith.co.uk/2011/04/18/monitoring-table-and-index-io-with-performance_schema/</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/MySQL-feature/">MySQL feature</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2015/07/17/22_performance_schema/" data-title="Mysql5.6 Performance_schema 深入浅出 | Focus on MySQL,Focus on Focus" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/08/18/how_to_backup_recovery/" title="MySQL 备份与恢复">
  <strong>PREVIOUS:</strong><br/>
  <span>
  MySQL 备份与恢复</span>
</a>
</div>


<div class="next">
<a href="/2015/07/16/ref_56/"  title="Mysql5.6 新特性">
 <strong>NEXT:</strong><br/> 
 <span>Mysql5.6 新特性
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2015/07/17/22_performance_schema/" data-title="Mysql5.6 Performance_schema 深入浅出" data-url="https://Keithlan.github.io/2015/07/17/22_performance_schema/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目录结构"><span class="toc-number">1.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#架构图"><span class="toc-number">2.</span> <span class="toc-text">架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql_5-5_Performance_schema"><span class="toc-number">3.</span> <span class="toc-text">Mysql 5.5 Performance schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql_5-6_Performance_schema"><span class="toc-number">4.</span> <span class="toc-text">Mysql 5.6 Performance schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql_5-7_Performance_schema"><span class="toc-number">5.</span> <span class="toc-text">Mysql 5.7 Performance schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#consumer_层次图"><span class="toc-number">6.</span> <span class="toc-text">consumer 层次图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Statement_诊断"><span class="toc-number">7.</span> <span class="toc-text">Statement 诊断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-1_performance_Schema_快速入门"><span class="toc-number">8.</span> <span class="toc-text">22.1 performance Schema 快速入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-2_Performance_Schema_配置"><span class="toc-number">9.</span> <span class="toc-text">22.2 Performance Schema 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-1_mysql编译的时候_修改Performance_Schema配置"><span class="toc-number">9.1.</span> <span class="toc-text">22.2.1 mysql编译的时候 修改Performance Schema配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-2_mysql启动的时候_修改Performance_Schema配置"><span class="toc-number">9.2.</span> <span class="toc-text">22.2.2 mysql启动的时候 修改Performance Schema配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-2-3_mysql运行过程中_修改Performance_Schema配置"><span class="toc-number">9.3.</span> <span class="toc-text">22.2.3 mysql运行过程中 修改Performance Schema配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-3-1_performance_schema事件计时"><span class="toc-number">9.3.1.</span> <span class="toc-text">22.2.3.1 performance_schema事件计时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-3-2_performance_schema_过滤事件"><span class="toc-number">9.3.2.</span> <span class="toc-text">22.2.3.2 performance_schema 过滤事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#22-2-3-3_Pre-Filtering_事件"><span class="toc-number">9.3.3.</span> <span class="toc-text">22.2.3.3 Pre-Filtering 事件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-1_Pre-Filtering_by_Instrument"><span class="toc-number">9.3.3.1.</span> <span class="toc-text">22.2.3.3.1 Pre-Filtering by Instrument</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-2_Pre-Filtering_by_Object"><span class="toc-number">9.3.3.2.</span> <span class="toc-text">22.2.3.3.2 Pre-Filtering by Object</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-3_Pre-Filtering_by_Thread"><span class="toc-number">9.3.3.3.</span> <span class="toc-text">22.2.3.3.3 Pre-Filtering by Thread</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-4_Pre-Filtering_by_Consumer"><span class="toc-number">9.3.3.4.</span> <span class="toc-text">22.2.3.3.4 Pre-Filtering by Consumer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#22-2-3-3-5_Example_Consumer_Configurations"><span class="toc-number">9.3.3.5.</span> <span class="toc-text">22.2.3.3.5 Example Consumer Configurations</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-3_Performance_Schema_Queries"><span class="toc-number">10.</span> <span class="toc-text">22.3 Performance Schema Queries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-4_Performance_Schema_Instrument命名规则"><span class="toc-number">11.</span> <span class="toc-text">22.4 Performance Schema Instrument命名规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-5_performance_schema_状态监控"><span class="toc-number">12.</span> <span class="toc-text">22.5 performance schema 状态监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-8_Performance_Schema_General_Table_Characteristics"><span class="toc-number">13.</span> <span class="toc-text">22.8 Performance Schema General Table Characteristics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后注意事项"><span class="toc-number">14.</span> <span class="toc-text">最后注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">15.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1)_源码：https://github-com/MarkLeith/mysql-sys/"><span class="toc-number">15.1.</span> <span class="toc-text">1) 源码：https://github.com/MarkLeith/mysql-sys/</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）这里面的代码参考Mark_leith，有部分做过修改，也有部分对线上影响非常大。"><span class="toc-number">15.2.</span> <span class="toc-text">2）这里面的代码参考Mark leith，有部分做过修改，也有部分对线上影响非常大。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3）对所有view都做过详细解释与实战测试，有部分坑里面说明"><span class="toc-number">15.3.</span> <span class="toc-text">3）对所有view都做过详细解释与实战测试，有部分坑里面说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">16.</span> <span class="toc-text">参考资料</span></a></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>22</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>21</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>1</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>20</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
